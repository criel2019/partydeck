================================================================================
ì„¹ì…˜ 1: HTML
================================================================================
<!-- TRUTH GAME -->
<div class="screen" id="truthGame">
  <!-- ìƒë‹¨ ë°” -->
  <div class="truth-top-bar">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">âœ•</button>
    <div class="truth-round-display">
      <span class="truth-round-badge" id="truthRoundBadge">ROUND 1</span>
    </div>
    <div class="truth-questioner-display" id="truthQuestionerDisplay">ì§ˆë¬¸ì: ---</div>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
  <div class="truth-content">

    <!-- Phase: question (ì§ˆë¬¸ì ì…ë ¥) -->
    <div class="truth-phase-area" id="truthQuestionInputArea" style="display:none;">
      <div class="truth-your-turn-badge">âœ¨ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤</div>
      <div class="truth-question-box">
        <textarea
          class="truth-textarea"
          id="truthQuestionInput"
          placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...&#10;ì˜ˆ: ì—¬ê¸°ì„œ OOë¥¼ ì´ì„±ì ìœ¼ë¡œ ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒì´ ìˆë‹¤?"
          maxlength="200"
          rows="3"
        ></textarea>
        <div class="truth-char-count"><span id="truthCharCount">0</span>/200</div>
      </div>
      <button class="btn btn-primary truth-submit-btn" onclick="submitTruthQuestion()">
        ğŸ“¨ ì§ˆë¬¸ ì œì¶œ
      </button>
    </div>

    <!-- Phase: question (ëŒ€ê¸° í™”ë©´ - ì§ˆë¬¸ìê°€ ì•„ë‹Œ ê²½ìš°) -->
    <div class="truth-phase-area" id="truthWaitQuestionArea" style="display:none;">
      <div class="truth-waiting-icon">ğŸ¤”</div>
      <div class="truth-waiting-text" id="truthWaitingText">ì§ˆë¬¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
      <div class="truth-waiting-sub" id="truthWaitingSubText">ì§ˆë¬¸ìê°€ ì§ˆë¬¸ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
      <div class="truth-dots-loader">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- Phase: voting (ì§ˆë¬¸ í‘œì‹œ + O/X íˆ¬í‘œ) -->
    <div class="truth-phase-area" id="truthVotingArea" style="display:none;">
      <div class="truth-question-display">
        <div class="truth-question-label">Q.</div>
        <div class="truth-question-text" id="truthQuestionText">ì§ˆë¬¸ ë‚´ìš©</div>
      </div>

      <!-- íˆ¬í‘œ ë²„íŠ¼ ì˜ì—­ -->
      <div class="truth-vote-buttons" id="truthVoteButtons">
        <button class="truth-vote-btn truth-vote-o" id="truthBtnO" onclick="castTruthVote('O')">
          <span class="truth-vote-symbol">O</span>
          <span class="truth-vote-label">ì˜ˆ</span>
        </button>
        <button class="truth-vote-btn truth-vote-x" id="truthBtnX" onclick="castTruthVote('X')">
          <span class="truth-vote-symbol">âœ•</span>
          <span class="truth-vote-label">ì•„ë‹ˆì˜¤</span>
        </button>
      </div>

      <!-- íˆ¬í‘œ ì™„ë£Œ í›„ ëŒ€ê¸° -->
      <div class="truth-vote-waiting" id="truthVoteWaiting" style="display:none;">
        <div class="truth-voted-badge" id="truthVotedBadge">âœ… íˆ¬í‘œ ì™„ë£Œ</div>
        <div class="truth-vote-progress">
          <div class="truth-progress-bar">
            <div class="truth-progress-fill" id="truthProgressFill" style="width:0%"></div>
          </div>
          <div class="truth-progress-text" id="truthProgressText">íˆ¬í‘œ ì¤‘... (0/0ëª… ì™„ë£Œ)</div>
        </div>
      </div>
    </div>

    <!-- Phase: result (ê²°ê³¼ í‘œì‹œ) -->
    <div class="truth-phase-area" id="truthResultArea" style="display:none;">
      <div class="truth-question-display truth-question-display-small">
        <div class="truth-question-label">Q.</div>
        <div class="truth-question-text" id="truthResultQuestionText">ì§ˆë¬¸ ë‚´ìš©</div>
      </div>

      <div class="truth-result-container">
        <div class="truth-result-title">íˆ¬í‘œ ê²°ê³¼</div>

        <!-- O ê²°ê³¼ -->
        <div class="truth-result-row">
          <div class="truth-result-icon truth-result-icon-o">O</div>
          <div class="truth-result-info">
            <div class="truth-result-count" id="truthResultOCount">0ëª…</div>
            <div class="truth-result-dots" id="truthResultODots"></div>
          </div>
        </div>

        <!-- X ê²°ê³¼ -->
        <div class="truth-result-row">
          <div class="truth-result-icon truth-result-icon-x">âœ•</div>
          <div class="truth-result-info">
            <div class="truth-result-count" id="truthResultXCount">0ëª…</div>
            <div class="truth-result-dots" id="truthResultXDots"></div>
          </div>
        </div>

        <!-- ì´ì› -->
        <div class="truth-result-total" id="truthResultTotal">ì´ 0ëª… ì°¸ì—¬</div>
      </div>

      <!-- ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ (ì§ˆë¬¸ì ë˜ëŠ” í˜¸ìŠ¤íŠ¸) -->
      <button class="btn btn-accent2 truth-next-btn" id="truthNextBtn" onclick="truthNextRound()" style="display:none;">
        â¡ï¸ ë‹¤ìŒ ì§ˆë¬¸
      </button>
      <div class="truth-next-waiting" id="truthNextWaiting" style="display:none;">
        ë‹¤ìŒ ì§ˆë¬¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
      </div>
    </div>

  </div>

  <!-- í•˜ë‹¨ í”Œë ˆì´ì–´ í‘œì‹œ -->
  <div class="truth-players-bar" id="truthPlayersBar"></div>
</div>


================================================================================
ì„¹ì…˜ 2: CSS
================================================================================
/* TRUTH GAME CSS */

/* ===== ì „ì²´ ë ˆì´ì•„ì›ƒ ===== */
#truthGame {
  padding: 12px 16px;
  gap: 10px;
  background:
    radial-gradient(ellipse at 30% 70%, rgba(0,230,118,0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 30%, rgba(255,23,68,0.04) 0%, transparent 50%),
    linear-gradient(180deg, #0d0d14 0%, #0a0a12 50%, #08080e 100%);
  position: relative;
  overflow: hidden;
}

#truthGame::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(255,255,255,0.008) 2px,
      rgba(255,255,255,0.008) 4px
    );
  pointer-events: none;
  z-index: 0;
}

#truthGame > * { position: relative; z-index: 1; }

/* ===== ìƒë‹¨ ë°” ===== */
.truth-top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: linear-gradient(135deg, rgba(20,20,42,0.95), rgba(28,28,58,0.9));
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.06);
  backdrop-filter: blur(10px);
}

.truth-round-badge {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 15px;
  color: var(--accent2);
  letter-spacing: 2px;
}

.truth-questioner-display {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-dim);
}

/* ===== ë©”ì¸ ì½˜í…ì¸  ===== */
.truth-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 0;
  overflow-y: auto;
  padding: 8px 0;
}

.truth-phase-area {
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  animation: truthFadeIn 0.4s ease;
}

@keyframes truthFadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ===== ì§ˆë¬¸ ì…ë ¥ (ì§ˆë¬¸ì) ===== */
.truth-your-turn-badge {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 22px;
  color: var(--gold);
  text-align: center;
  text-shadow: 0 0 20px rgba(255,215,0,0.3);
}

.truth-question-box {
  width: 100%;
  position: relative;
}

.truth-textarea {
  width: 100%;
  padding: 16px;
  background: var(--bg-surface);
  border: 2px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 16px;
  font-family: inherit;
  outline: none;
  resize: none;
  transition: border-color 0.3s;
  line-height: 1.5;
}

.truth-textarea:focus {
  border-color: var(--accent2);
  box-shadow: 0 0 20px rgba(0,229,255,0.1);
}

.truth-textarea::placeholder {
  color: var(--text-dim);
  font-size: 14px;
}

.truth-char-count {
  position: absolute;
  bottom: 8px;
  right: 12px;
  font-size: 11px;
  color: var(--text-dim);
}

.truth-submit-btn {
  max-width: 100%;
}

/* ===== ëŒ€ê¸° í™”ë©´ ===== */
.truth-waiting-icon {
  font-size: 64px;
  animation: float 3s ease-in-out infinite;
}

.truth-waiting-text {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 22px;
  color: var(--text);
}

.truth-waiting-sub {
  font-size: 14px;
  color: var(--text-dim);
  text-align: center;
}

.truth-dots-loader {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 8px;
}

.truth-dots-loader span {
  width: 10px;
  height: 10px;
  background: var(--accent2);
  border-radius: 50%;
  animation: truthDotPulse 1.4s ease-in-out infinite;
}

.truth-dots-loader span:nth-child(2) { animation-delay: 0.2s; }
.truth-dots-loader span:nth-child(3) { animation-delay: 0.4s; }

@keyframes truthDotPulse {
  0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1.2); }
}

/* ===== ì§ˆë¬¸ í‘œì‹œ ===== */
.truth-question-display {
  width: 100%;
  padding: 20px;
  background: linear-gradient(135deg, rgba(20,20,42,0.95), rgba(28,28,58,0.85));
  border-radius: var(--radius);
  border: 1px solid rgba(0,229,255,0.15);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.truth-question-display::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent2), var(--accent), var(--accent2));
}

.truth-question-display-small {
  padding: 14px;
}

.truth-question-display-small .truth-question-text {
  font-size: 16px;
}

.truth-question-label {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 28px;
  color: var(--accent2);
  margin-bottom: 8px;
  text-shadow: 0 0 15px rgba(0,229,255,0.4);
}

.truth-question-display-small .truth-question-label {
  font-size: 20px;
  margin-bottom: 4px;
}

.truth-question-text {
  font-size: 20px;
  font-weight: 700;
  line-height: 1.5;
  word-break: keep-all;
}

/* ===== O/X íˆ¬í‘œ ë²„íŠ¼ ===== */
.truth-vote-buttons {
  display: flex;
  gap: 20px;
  width: 100%;
  justify-content: center;
  padding: 10px 0;
}

.truth-vote-btn {
  width: 130px;
  height: 130px;
  border: none;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.truth-vote-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.15);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.4s, height 0.4s;
}

.truth-vote-btn:active::before {
  width: 200px;
  height: 200px;
}

.truth-vote-btn:active {
  transform: scale(0.92);
}

/* O ë²„íŠ¼ - ì›í˜•, ì´ˆë¡ */
.truth-vote-o {
  border-radius: 50%;
  background: linear-gradient(145deg, #00e676, #00c853);
  box-shadow:
    0 6px 30px rgba(0,230,118,0.4),
    0 0 60px rgba(0,230,118,0.15),
    inset 0 2px 4px rgba(255,255,255,0.25),
    inset 0 -3px 6px rgba(0,0,0,0.2);
}

.truth-vote-o:hover {
  box-shadow:
    0 8px 40px rgba(0,230,118,0.5),
    0 0 80px rgba(0,230,118,0.2),
    inset 0 2px 4px rgba(255,255,255,0.25),
    inset 0 -3px 6px rgba(0,0,0,0.2);
}

/* X ë²„íŠ¼ - ì‚¬ê°í˜•, ë¹¨ê°• */
.truth-vote-x {
  border-radius: var(--radius);
  background: linear-gradient(145deg, #ff1744, #d50000);
  box-shadow:
    0 6px 30px rgba(255,23,68,0.4),
    0 0 60px rgba(255,23,68,0.15),
    inset 0 2px 4px rgba(255,255,255,0.25),
    inset 0 -3px 6px rgba(0,0,0,0.2);
}

.truth-vote-x:hover {
  box-shadow:
    0 8px 40px rgba(255,23,68,0.5),
    0 0 80px rgba(255,23,68,0.2),
    inset 0 2px 4px rgba(255,255,255,0.25),
    inset 0 -3px 6px rgba(0,0,0,0.2);
}

.truth-vote-symbol {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 48px;
  color: white;
  text-shadow: 0 2px 8px rgba(0,0,0,0.3);
  line-height: 1;
}

.truth-vote-label {
  font-size: 14px;
  font-weight: 700;
  color: rgba(255,255,255,0.9);
}

.truth-vote-btn.selected {
  animation: truthBtnPulse 0.5s ease;
}

.truth-vote-btn.disabled {
  opacity: 0.3;
  pointer-events: none;
  filter: grayscale(0.5);
}

@keyframes truthBtnPulse {
  0%   { transform: scale(1); }
  30%  { transform: scale(1.1); }
  60%  { transform: scale(0.95); }
  100% { transform: scale(1); }
}

/* ===== íˆ¬í‘œ ëŒ€ê¸° ===== */
.truth-vote-waiting {
  width: 100%;
  text-align: center;
}

.truth-voted-badge {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 20px;
  color: var(--success);
  margin-bottom: 16px;
  text-shadow: 0 0 15px rgba(0,230,118,0.3);
}

.truth-vote-progress {
  width: 100%;
  max-width: 300px;
  margin: 0 auto;
}

.truth-progress-bar {
  width: 100%;
  height: 8px;
  background: var(--bg-surface);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.truth-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent2), var(--accent));
  border-radius: 4px;
  transition: width 0.4s ease;
}

.truth-progress-text {
  font-size: 14px;
  color: var(--text-dim);
  font-weight: 700;
}

/* ===== ê²°ê³¼ ì˜ì—­ ===== */
.truth-result-container {
  width: 100%;
  padding: 24px 20px;
  background: linear-gradient(135deg, rgba(20,20,42,0.95), rgba(28,28,58,0.85));
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.06);
}

.truth-result-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 18px;
  color: var(--text-dim);
  text-align: center;
  margin-bottom: 20px;
  letter-spacing: 2px;
}

.truth-result-row {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 16px;
  padding: 12px 16px;
  background: rgba(0,0,0,0.2);
  border-radius: var(--radius-sm);
}

.truth-result-icon {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Black Han Sans', sans-serif;
  font-size: 26px;
  color: white;
  flex-shrink: 0;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.truth-result-icon-o {
  background: linear-gradient(145deg, #00e676, #00c853);
  box-shadow: 0 4px 20px rgba(0,230,118,0.35), 0 0 40px rgba(0,230,118,0.1);
}

.truth-result-icon-x {
  background: linear-gradient(145deg, #ff1744, #d50000);
  box-shadow: 0 4px 20px rgba(255,23,68,0.35), 0 0 40px rgba(255,23,68,0.1);
}

.truth-result-info {
  flex: 1;
}

.truth-result-count {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 28px;
  color: var(--text);
  margin-bottom: 6px;
}

.truth-result-dots {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.truth-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.truth-dot.filled-o {
  background: var(--success);
  box-shadow: 0 0 8px rgba(0,230,118,0.5);
  animation: truthDotAppear 0.4s ease backwards;
}

.truth-dot.filled-x {
  background: var(--danger);
  box-shadow: 0 0 8px rgba(255,23,68,0.5);
  animation: truthDotAppear 0.4s ease backwards;
}

.truth-dot.empty {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.1);
}

@keyframes truthDotAppear {
  from { transform: scale(0); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

.truth-result-total {
  text-align: center;
  font-size: 13px;
  color: var(--text-dim);
  margin-top: 4px;
  font-weight: 700;
}

/* ===== ë‹¤ìŒ ë¼ìš´ë“œ ===== */
.truth-next-btn {
  max-width: 100%;
}

.truth-next-waiting {
  font-size: 14px;
  color: var(--text-dim);
  text-align: center;
  font-weight: 700;
}

/* ===== í•˜ë‹¨ í”Œë ˆì´ì–´ ë°” ===== */
.truth-players-bar {
  display: flex;
  gap: 8px;
  padding: 10px 8px;
  background: linear-gradient(135deg, rgba(20,20,42,0.9), rgba(28,28,58,0.85));
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.04);
  overflow-x: auto;
  flex-shrink: 0;
  justify-content: center;
}

.truth-player-chip {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  min-width: 48px;
  flex-shrink: 0;
}

.truth-player-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  position: relative;
  transition: all 0.3s;
}

.truth-player-avatar.is-questioner {
  box-shadow: 0 0 0 3px var(--gold), 0 0 16px rgba(255,215,0,0.4);
}

.truth-player-avatar.has-voted::after {
  content: 'âœ“';
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 16px;
  height: 16px;
  background: var(--success);
  border-radius: 50%;
  font-size: 9px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
}

.truth-player-name {
  font-size: 10px;
  font-weight: 700;
  max-width: 52px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-align: center;
  color: var(--text-dim);
}

.truth-player-name.active-name {
  color: var(--gold);
}


================================================================================
ì„¹ì…˜ 3: JS
================================================================================
// ===== TRUTH GAME ENGINE =====

// --- í˜¸ìŠ¤íŠ¸ ìƒíƒœ ---
let truthState = null;

function startTruthGame() {
  if (!state.isHost) return;
  if (state.players.length < 3) {
    showToast('ì§„ì‹¤ê²Œì„ì€ 3ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤');
    return;
  }

  truthState = {
    round: 1,
    questionerIdx: 0,
    question: '',
    votes: {},           // { playerId: 'O' | 'X' }
    votedSet: new Set(),
    phase: 'question',   // 'question' | 'voting' | 'result'
    playerOrder: state.players.map(p => p.id),
    playerMap: {},
  };

  // í”Œë ˆì´ì–´ ë§µ êµ¬ì¶•
  state.players.forEach((p, i) => {
    truthState.playerMap[p.id] = {
      id: p.id,
      name: p.name,
      avatar: p.avatar,
      colorIdx: i,
    };
  });

  // í˜¸ìŠ¤íŠ¸ ìì‹ ì—ê²Œë„ game-start ì „ë‹¬
  const initView = buildTruthView(state.myId);
  showScreen('truthGame');
  renderTruthView(initView);

  // ë‹¤ë¥¸ í”Œë ˆì´ì–´ì—ê²Œ game-start + ì´ˆê¸° ë·° ì „ì†¡
  state.players.forEach(p => {
    if (p.id !== state.myId) {
      const view = buildTruthView(p.id);
      sendTo(p.id, {
        type: 'game-start',
        game: 'truth',
        state: view,
      });
    }
  });
}

// ê° í”Œë ˆì´ì–´ì—ê²Œ ë§ì¶¤ ë·° ìƒì„±
function buildTruthView(forPlayerId) {
  const ts = truthState;
  const questionerId = ts.playerOrder[ts.questionerIdx];
  const isQuestioner = (forPlayerId === questionerId);
  const totalPlayers = ts.playerOrder.length;

  // íˆ¬í‘œ ìƒí™©: ëˆ„ê°€ íˆ¬í‘œí–ˆëŠ”ì§€ë§Œ (ë­˜ íˆ¬í‘œí–ˆëŠ”ì§€ëŠ” ë¹„ê³µê°œ)
  const votedList = Array.from(ts.votedSet || []);
  const voteCount = votedList.length;

  // ê²°ê³¼: phase === 'result'ì¼ ë•Œë§Œ O/X ì¹´ìš´íŠ¸ ì „ì†¡
  let oCount = 0;
  let xCount = 0;
  if (ts.phase === 'result') {
    Object.values(ts.votes).forEach(v => {
      if (v === 'O') oCount++;
      else if (v === 'X') xCount++;
    });
  }

  // ë‚´ê°€ ì´ë¯¸ íˆ¬í‘œí–ˆëŠ”ì§€
  const myVoted = ts.votedSet ? ts.votedSet.has(forPlayerId) : false;

  return {
    type: 'truth-state',
    round: ts.round,
    phase: ts.phase,
    questionerId: questionerId,
    questionerName: ts.playerMap[questionerId]?.name || '???',
    isQuestioner: isQuestioner,
    question: ts.phase !== 'question' ? ts.question : (isQuestioner ? '' : ''),
    totalPlayers: totalPlayers,
    voteCount: voteCount,
    votedList: votedList,
    myVoted: myVoted,
    oCount: oCount,
    xCount: xCount,
    players: ts.playerOrder.map(pid => ({
      id: pid,
      name: ts.playerMap[pid]?.name || '???',
      avatar: ts.playerMap[pid]?.avatar || 'ğŸ˜',
      colorIdx: ts.playerMap[pid]?.colorIdx || 0,
      isQuestioner: pid === questionerId,
      hasVoted: ts.votedSet ? ts.votedSet.has(pid) : false,
    })),
    // í˜¸ìŠ¤íŠ¸ ì—¬ë¶€ (ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰ ê¶Œí•œ)
    isHost: forPlayerId === state.myId && state.isHost,
  };
}

function broadcastTruthState() {
  if (!truthState) return;
  const ts = truthState;

  ts.playerOrder.forEach(pid => {
    const view = buildTruthView(pid);
    if (pid === state.myId) {
      renderTruthView(view);
    } else {
      sendTo(pid, view);
    }
  });
}

// --- ë©”ì‹œì§€ ì²˜ë¦¬ (í˜¸ìŠ¤íŠ¸) ---
function processTruthQuestion(peerId, question) {
  if (!truthState || truthState.phase !== 'question') return;
  const questionerId = truthState.playerOrder[truthState.questionerIdx];
  if (peerId !== questionerId) return;

  truthState.question = question;
  truthState.phase = 'voting';
  truthState.votes = {};
  truthState.votedSet = new Set();

  broadcastTruthState();
}

function processTruthVote(peerId, vote) {
  if (!truthState || truthState.phase !== 'voting') return;
  if (truthState.votedSet.has(peerId)) return; // ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€
  if (vote !== 'O' && vote !== 'X') return;

  truthState.votes[peerId] = vote;
  truthState.votedSet.add(peerId);

  // ëª¨ë‘ íˆ¬í‘œ ì™„ë£Œ?
  if (truthState.votedSet.size >= truthState.playerOrder.length) {
    truthState.phase = 'result';
    broadcastTruthState();
  } else {
    // ì§„í–‰ ìƒí™©ë§Œ ì—…ë°ì´íŠ¸
    broadcastTruthState();
  }
}

function processTruthNext() {
  if (!truthState) return;
  truthState.round++;
  truthState.questionerIdx = (truthState.questionerIdx + 1) % truthState.playerOrder.length;
  truthState.question = '';
  truthState.votes = {};
  truthState.votedSet = new Set();
  truthState.phase = 'question';

  broadcastTruthState();
}

// --- ë Œë”ë§ ---
function renderTruthView(view) {
  if (!view) return;

  // ìƒë‹¨ ë°”
  document.getElementById('truthRoundBadge').textContent = 'ROUND ' + view.round;
  document.getElementById('truthQuestionerDisplay').textContent = 'ì§ˆë¬¸ì: ' + view.questionerName;

  // ëª¨ë“  phase ì˜ì—­ ìˆ¨ê¸°ê¸°
  document.getElementById('truthQuestionInputArea').style.display = 'none';
  document.getElementById('truthWaitQuestionArea').style.display = 'none';
  document.getElementById('truthVotingArea').style.display = 'none';
  document.getElementById('truthResultArea').style.display = 'none';

  if (view.phase === 'question') {
    if (view.isQuestioner) {
      // ì§ˆë¬¸ì: ì…ë ¥ í™”ë©´
      document.getElementById('truthQuestionInputArea').style.display = 'flex';
      document.getElementById('truthQuestionInput').value = '';
      document.getElementById('truthCharCount').textContent = '0';
    } else {
      // ë¹„ì§ˆë¬¸ì: ëŒ€ê¸° í™”ë©´
      document.getElementById('truthWaitQuestionArea').style.display = 'flex';
      document.getElementById('truthWaitingText').textContent = 'ì§ˆë¬¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
      document.getElementById('truthWaitingSubText').textContent =
        view.questionerName + 'ë‹˜ì´ ì§ˆë¬¸ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤';
    }
  } else if (view.phase === 'voting') {
    document.getElementById('truthVotingArea').style.display = 'flex';
    document.getElementById('truthQuestionText').textContent = view.question;

    if (view.myVoted) {
      // ì´ë¯¸ íˆ¬í‘œí•¨ -> ëŒ€ê¸° í™”ë©´
      document.getElementById('truthVoteButtons').style.display = 'none';
      document.getElementById('truthVoteWaiting').style.display = 'block';
      const pct = Math.round((view.voteCount / view.totalPlayers) * 100);
      document.getElementById('truthProgressFill').style.width = pct + '%';
      document.getElementById('truthProgressText').textContent =
        'íˆ¬í‘œ ì¤‘... (' + view.voteCount + '/' + view.totalPlayers + 'ëª… ì™„ë£Œ)';
    } else {
      // ì•„ì§ íˆ¬í‘œ ì•ˆ í•¨ -> ë²„íŠ¼ í‘œì‹œ
      document.getElementById('truthVoteButtons').style.display = 'flex';
      document.getElementById('truthVoteWaiting').style.display = 'none';
      // ë²„íŠ¼ ì´ˆê¸°í™”
      document.getElementById('truthBtnO').classList.remove('selected', 'disabled');
      document.getElementById('truthBtnX').classList.remove('selected', 'disabled');
    }
  } else if (view.phase === 'result') {
    document.getElementById('truthResultArea').style.display = 'flex';
    document.getElementById('truthResultQuestionText').textContent = view.question;
    document.getElementById('truthResultOCount').textContent = view.oCount + 'ëª…';
    document.getElementById('truthResultXCount').textContent = view.xCount + 'ëª…';
    document.getElementById('truthResultTotal').textContent =
      'ì´ ' + view.totalPlayers + 'ëª… ì°¸ì—¬';

    // O LED ë„íŠ¸
    const oDots = document.getElementById('truthResultODots');
    let oHTML = '';
    for (let i = 0; i < view.totalPlayers; i++) {
      const delay = (i * 0.08).toFixed(2);
      if (i < view.oCount) {
        oHTML += '<div class="truth-dot filled-o" style="animation-delay:' + delay + 's"></div>';
      } else {
        oHTML += '<div class="truth-dot empty"></div>';
      }
    }
    oDots.innerHTML = oHTML;

    // X LED ë„íŠ¸
    const xDots = document.getElementById('truthResultXDots');
    let xHTML = '';
    for (let i = 0; i < view.totalPlayers; i++) {
      const delay = (i * 0.08).toFixed(2);
      if (i < view.xCount) {
        xHTML += '<div class="truth-dot filled-x" style="animation-delay:' + delay + 's"></div>';
      } else {
        xHTML += '<div class="truth-dot empty"></div>';
      }
    }
    xDots.innerHTML = xHTML;

    // ë‹¤ìŒ ë¼ìš´ë“œ ë²„íŠ¼: í˜¸ìŠ¤íŠ¸ë§Œ í‘œì‹œ
    if (view.isHost) {
      document.getElementById('truthNextBtn').style.display = 'block';
      document.getElementById('truthNextWaiting').style.display = 'none';
    } else {
      document.getElementById('truthNextBtn').style.display = 'none';
      document.getElementById('truthNextWaiting').style.display = 'block';
    }
  }

  // í•˜ë‹¨ í”Œë ˆì´ì–´ ë°”
  renderTruthPlayersBar(view.players);
}

function renderTruthPlayersBar(players) {
  const bar = document.getElementById('truthPlayersBar');
  bar.innerHTML = players.map(p => {
    const isMe = p.id === state.myId;
    const avatarClasses = [
      'truth-player-avatar',
      p.isQuestioner ? 'is-questioner' : '',
      p.hasVoted ? 'has-voted' : '',
    ].filter(Boolean).join(' ');

    const nameClass = p.isQuestioner ? 'truth-player-name active-name' : 'truth-player-name';

    return '<div class="truth-player-chip">' +
      '<div class="' + avatarClasses + '" style="background:' + PLAYER_COLORS[p.colorIdx % PLAYER_COLORS.length] + ';">' +
        p.avatar +
      '</div>' +
      '<div class="' + nameClass + '">' + (isMe ? 'ë‚˜' : p.name) + '</div>' +
    '</div>';
  }).join('');
}

// --- í´ë¼ì´ì–¸íŠ¸ ì•¡ì…˜ ---
function submitTruthQuestion() {
  const input = document.getElementById('truthQuestionInput');
  const question = input.value.trim();
  if (!question) {
    showToast('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  if (question.length > 200) {
    showToast('ì§ˆë¬¸ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (200ì ì´ë‚´)');
    return;
  }

  if (state.isHost) {
    // í˜¸ìŠ¤íŠ¸ê°€ ì§ì ‘ ì§ˆë¬¸ìì¸ ê²½ìš°
    processTruthQuestion(state.myId, question);
  } else {
    // í˜¸ìŠ¤íŠ¸ì—ê²Œ ì „ì†¡
    const hostConn = Object.values(state.connections)[0];
    if (hostConn?.open) {
      hostConn.send(JSON.stringify({
        type: 'truth-question',
        question: question,
      }));
    }
  }
}

function castTruthVote(vote) {
  // UI ì¦‰ì‹œ ë°˜ì‘
  const btnO = document.getElementById('truthBtnO');
  const btnX = document.getElementById('truthBtnX');

  if (vote === 'O') {
    btnO.classList.add('selected');
    btnX.classList.add('disabled');
  } else {
    btnX.classList.add('selected');
    btnO.classList.add('disabled');
  }

  // ì ì‹œ í›„ ë²„íŠ¼ ìˆ¨ê¸°ê³  ëŒ€ê¸° í™”ë©´
  setTimeout(() => {
    document.getElementById('truthVoteButtons').style.display = 'none';
    document.getElementById('truthVoteWaiting').style.display = 'block';
    document.getElementById('truthVotedBadge').textContent =
      vote === 'O' ? 'â­• íˆ¬í‘œ ì™„ë£Œ' : 'âŒ íˆ¬í‘œ ì™„ë£Œ';
  }, 400);

  if (state.isHost) {
    processTruthVote(state.myId, vote);
  } else {
    const hostConn = Object.values(state.connections)[0];
    if (hostConn?.open) {
      hostConn.send(JSON.stringify({
        type: 'truth-vote',
        vote: vote,
      }));
    }
  }
}

function truthNextRound() {
  if (state.isHost) {
    processTruthNext();
  } else {
    const hostConn = Object.values(state.connections)[0];
    if (hostConn?.open) {
      hostConn.send(JSON.stringify({
        type: 'truth-next',
      }));
    }
  }
}

// --- textarea ê¸€ììˆ˜ ì¹´ìš´íŠ¸ ---
document.addEventListener('DOMContentLoaded', function() {
  // DOMContentLoaded ì´í›„ ë°”ì¸ë”© ì‹œë„ (truthGame HTML ì‚½ì… í›„)
  const ta = document.getElementById('truthQuestionInput');
  if (ta) {
    ta.addEventListener('input', function() {
      const cnt = document.getElementById('truthCharCount');
      if (cnt) cnt.textContent = ta.value.length;
    });
  }
});

// ë§Œì•½ ë™ì ìœ¼ë¡œ ë Œë”ë§ë˜ì–´ ìœ„ ì´ë²¤íŠ¸ê°€ ë†“ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ë²¤íŠ¸ ìœ„ì„ë„ ì¶”ê°€
document.addEventListener('input', function(e) {
  if (e.target && e.target.id === 'truthQuestionInput') {
    const cnt = document.getElementById('truthCharCount');
    if (cnt) cnt.textContent = e.target.value.length;
  }
});


// =========================================================
// handleMessageì— ì¶”ê°€í•  í•¸ë“¤ëŸ¬ (ê¸°ì¡´ handlers ê°ì²´ì— ë³‘í•©)
// =========================================================
//
// ê¸°ì¡´ handleMessage í•¨ìˆ˜ì˜ handlers ê°ì²´ì— ë‹¤ìŒ í•­ëª©ë“¤ì„ ì¶”ê°€:
//
//   'truth-state': () => {
//     showScreen('truthGame');
//     renderTruthView(msg);
//   },
//   'truth-question': () => {
//     if (state.isHost) processTruthQuestion(peerId, msg.question);
//   },
//   'truth-vote': () => {
//     if (state.isHost) processTruthVote(peerId, msg.vote);
//   },
//   'truth-next': () => {
//     if (state.isHost) processTruthNext();
//   },
//
// =========================================================


// =========================================================
// handleGameStartì— ì¶”ê°€í•  ë¶„ê¸° (ê¸°ì¡´ else-if ì²´ì¸ì— ì¶”ê°€)
// =========================================================
//
// ê¸°ì¡´:
//   else if(msg.game === 'truth') { showToast('ì§„ì‹¤ê²Œì„ ì‹œì‘!'); }
//
// ë³€ê²½:
//   else if(msg.game === 'truth') {
//     showScreen('truthGame');
//     renderTruthView(msg.state);
//   }
//
// =========================================================


// =========================================================
// ê¸°ì¡´ startTruthGame ìŠ¤í… êµì²´
// =========================================================
//
// ê¸°ì¡´:
//   function startTruthGame() { showToast('ì§„ì‹¤ê²Œì„ ì¤€ë¹„ ì¤‘...'); /* TODO */ }
//
// ìœ„ ì½”ë“œì˜ startTruthGame() í•¨ìˆ˜ë¡œ êµì²´
//
// =========================================================
