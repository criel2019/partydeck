<!-- QUICK DRAW GAME -->
<div class="screen" id="quickDrawGame">
  <div class="qd-header">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">âœ•</button>
    <div class="qd-title">ğŸ¤  ì„œë¶€ ì´ì¡ì´</div>
    <div class="qd-round">ë¼ìš´ë“œ <span id="qdRoundNum">1</span></div>
  </div>

  <div class="qd-main-area">
    <div class="qd-tap-zone" id="qdTapZone" onclick="qdTap()">
      <div class="qd-status-text" id="qdStatusText">ì¤€ë¹„...</div>
      <div class="qd-reaction-time" id="qdReactionTime"></div>
    </div>
  </div>

  <div class="qd-rankings">
    <div class="qd-rankings-title">ìˆœìœ„</div>
    <div class="qd-rankings-list" id="qdRankingsList"></div>
  </div>

  <button class="btn btn-primary qd-restart-btn" id="qdRestartBtn" style="display:none;" onclick="restartQuickDraw()">ë‹¤ì‹œ í•˜ê¸°</button>
</div>

<!-- ================== -->
/* QUICK DRAW CSS */
#quickDrawGame {
  padding: 16px;
  gap: 16px;
  background: linear-gradient(180deg, #1a0f0a 0%, #3d2817 100%);
}

.qd-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: rgba(20,20,42,0.7);
  border-radius: var(--radius-sm);
  backdrop-filter: blur(4px);
}

.qd-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 20px;
  color: #ff9800;
}

.qd-round {
  font-size: 13px;
  color: var(--text-dim);
  font-weight: 700;
}

.qd-main-area {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.qd-tap-zone {
  width: 280px;
  height: 280px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}

.qd-tap-zone.waiting {
  background: radial-gradient(circle, #2a2a3a, #1a1a2a);
  border: 4px solid rgba(255,255,255,0.1);
}

.qd-tap-zone.countdown {
  background: radial-gradient(circle, #4a3a2a, #2a1a1a);
  border: 4px solid rgba(255,152,0,0.3);
  animation: qd-pulse-countdown 1s ease-in-out infinite;
}

.qd-tap-zone.fire {
  background: radial-gradient(circle, #ff4444, #cc0000);
  border: 4px solid #ffaa00;
  box-shadow: 0 0 50px rgba(255,68,68,0.8), 0 8px 32px rgba(0,0,0,0.5);
  animation: qd-fire-pulse 0.5s ease-in-out infinite;
}

.qd-tap-zone.cheated {
  background: radial-gradient(circle, #666, #333);
  border: 4px solid #999;
}

.qd-tap-zone.done {
  background: radial-gradient(circle, #2a4a2a, #1a2a1a);
  border: 4px solid rgba(0,255,100,0.3);
}

@keyframes qd-pulse-countdown {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

@keyframes qd-fire-pulse {
  0%, 100% { transform: scale(1); box-shadow: 0 0 50px rgba(255,68,68,0.8), 0 8px 32px rgba(0,0,0,0.5); }
  50% { transform: scale(1.05); box-shadow: 0 0 80px rgba(255,68,68,1), 0 8px 40px rgba(0,0,0,0.6); }
}

.qd-status-text {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 42px;
  color: var(--text);
  text-align: center;
  text-shadow: 0 2px 8px rgba(0,0,0,0.5);
  margin-bottom: 12px;
}

.qd-tap-zone.fire .qd-status-text {
  font-size: 56px;
  color: #fff;
  animation: qd-fire-text 0.3s ease-in-out infinite;
}

@keyframes qd-fire-text {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.qd-reaction-time {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 32px;
  color: var(--accent2);
  text-align: center;
  min-height: 40px;
}

.qd-rankings {
  padding: 16px;
  background: var(--bg-card);
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.06);
  max-height: 200px;
  overflow-y: auto;
}

.qd-rankings-title {
  font-size: 14px;
  color: var(--text-dim);
  margin-bottom: 10px;
  font-weight: 700;
  text-align: center;
}

.qd-rankings-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.qd-ranking-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.04);
  animation: slideIn 0.3s ease;
}

.qd-ranking-item.winner {
  border-color: var(--gold);
  background: rgba(255,215,0,0.1);
}

.qd-ranking-rank {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 18px;
  color: var(--text-dim);
  min-width: 28px;
  text-align: center;
}

.qd-ranking-item.winner .qd-ranking-rank {
  color: var(--gold);
}

.qd-ranking-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.qd-ranking-name {
  flex: 1;
  font-weight: 700;
  font-size: 14px;
}

.qd-ranking-time {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 16px;
  color: var(--accent2);
}

.qd-ranking-item.cheated .qd-ranking-time {
  color: var(--danger);
  font-size: 14px;
}

.qd-restart-btn {
  max-width: 280px;
  align-self: center;
}

<!-- ================== -->
// ===== QUICK DRAW ENGINE =====

let qdState = {
  phase: 'waiting', // waiting, countdown, fire, result
  startTime: 0,
  results: {}, // {playerId: {time: ms, cheated: bool, name: str, avatar: str}}
  roundNum: 1,
  countdownTimeout: null,
  fireTimeout: null,
};

function startQuickDraw() {
  if(!state.isHost) return;

  qdState = {
    phase: 'waiting',
    startTime: 0,
    results: {},
    roundNum: state.quickdraw?.roundNum || 1,
    countdownTimeout: null,
    fireTimeout: null,
  };

  state.quickdraw = qdState;

  broadcast({ type: 'game-start', game: 'quickdraw', state: qdState });
  showScreen('quickDrawGame');
  renderQuickDrawView(qdState);

  // 3ì´ˆ ëŒ€ê¸° í›„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
  setTimeout(() => {
    qdState.phase = 'countdown';
    broadcastQDState();

    // ëœë¤ 2~6ì´ˆ í›„ ë°œì‚¬ ì‹ í˜¸
    const delay = 2000 + Math.random() * 4000;
    qdState.countdownTimeout = setTimeout(() => {
      qdState.phase = 'fire';
      qdState.startTime = Date.now();
      broadcastQDState();

      // ì§„ë™ íš¨ê³¼ (í˜¸ìŠ¤íŠ¸)
      if(navigator.vibrate) navigator.vibrate(200);

      // 5ì´ˆ í›„ ìë™ ê²°ê³¼ ì²˜ë¦¬
      qdState.fireTimeout = setTimeout(() => {
        resolveQD();
      }, 5000);
    }, delay);
  }, 3000);
}

function broadcastQDState() {
  const msg = {
    type: 'qd-state',
    phase: qdState.phase,
    startTime: qdState.startTime,
    results: qdState.results,
    roundNum: qdState.roundNum,
  };

  broadcast(msg);
  renderQuickDrawView(msg);
}

function renderQuickDrawView(qd) {
  if(!qd) return;

  const zone = document.getElementById('qdTapZone');
  const statusText = document.getElementById('qdStatusText');
  const reactionTime = document.getElementById('qdReactionTime');
  const roundNum = document.getElementById('qdRoundNum');

  roundNum.textContent = qd.roundNum;

  // ìƒíƒœë³„ UI ì—…ë°ì´íŠ¸
  zone.className = 'qd-tap-zone ' + qd.phase;

  switch(qd.phase) {
    case 'waiting':
      statusText.textContent = 'ì¤€ë¹„...';
      reactionTime.textContent = '';
      break;

    case 'countdown':
      statusText.textContent = 'â³';
      reactionTime.textContent = '';
      break;

    case 'fire':
      statusText.textContent = 'ë°œì‚¬!';
      reactionTime.textContent = '';

      // ì§„ë™ íš¨ê³¼
      if(navigator.vibrate) navigator.vibrate(200);
      break;

    case 'result':
      statusText.textContent = 'ê²°ê³¼';

      // ë‚´ ë°˜ì‘ì‹œê°„ í‘œì‹œ
      const myResult = qd.results[state.myId];
      if(myResult) {
        if(myResult.cheated) {
          reactionTime.textContent = 'ì‹¤ê²©!';
          reactionTime.style.color = 'var(--danger)';
        } else {
          reactionTime.textContent = (myResult.time / 1000).toFixed(3) + 'ì´ˆ';
          reactionTime.style.color = 'var(--accent2)';
        }
      } else {
        reactionTime.textContent = 'ë¯¸ì‘ë‹µ';
        reactionTime.style.color = 'var(--text-dim)';
      }

      // ë‹¤ì‹œ í•˜ê¸° ë²„íŠ¼ (í˜¸ìŠ¤íŠ¸ë§Œ)
      document.getElementById('qdRestartBtn').style.display = state.isHost ? 'block' : 'none';
      break;
  }

  // ìˆœìœ„ í‘œì‹œ
  renderQDRankings(qd);
}

function renderQDRankings(qd) {
  const list = document.getElementById('qdRankingsList');

  if(qd.phase !== 'result' || Object.keys(qd.results).length === 0) {
    list.innerHTML = '<div style="text-align:center;color:var(--text-dim);font-size:13px;padding:20px;">ëŒ€ê¸° ì¤‘...</div>';
    return;
  }

  // ê²°ê³¼ ì •ë ¬: ì‹¤ê²©ìëŠ” ë§¨ ë’¤, ë‚˜ë¨¸ì§€ëŠ” ì‹œê°„ìˆœ
  const sorted = Object.entries(qd.results)
    .map(([id, r]) => ({ id, ...r }))
    .sort((a, b) => {
      if(a.cheated && !b.cheated) return 1;
      if(!a.cheated && b.cheated) return -1;
      if(a.cheated && b.cheated) return 0;
      return a.time - b.time;
    });

  list.innerHTML = sorted.map((r, i) => {
    const rank = r.cheated ? 'âŒ' : (i + 1) + 'ìœ„';
    const timeStr = r.cheated ? 'ë„ˆë¬´ ë¹¨ë¼ìš”!' : (r.time / 1000).toFixed(3) + 'ì´ˆ';
    const isWinner = !r.cheated && i === 0;
    const playerIdx = state.players.findIndex(p => p.id === r.id);

    return `
      <div class="qd-ranking-item ${isWinner ? 'winner' : ''}">
        <div class="qd-ranking-rank">${rank}</div>
        <div class="qd-ranking-avatar" style="background:${PLAYER_COLORS[playerIdx % PLAYER_COLORS.length]};">${r.avatar}</div>
        <div class="qd-ranking-name">${r.name}</div>
        <div class="qd-ranking-time ${r.cheated ? 'cheated' : ''}">${timeStr}</div>
      </div>
    `;
  }).join('');
}

function qdTap() {
  const qd = qdState;
  const now = Date.now();

  // ì´ë¯¸ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë¬´ì‹œ
  if(qd.results[state.myId]) return;

  if(qd.phase === 'waiting') {
    // ë„ˆë¬´ ë¹ ë¦„
    return;
  } else if(qd.phase === 'countdown') {
    // ë¶€ì •í–‰ìœ„
    sendQDAction({ cheated: true, time: 0 });

    // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
    qdState.results[state.myId] = {
      cheated: true,
      time: 0,
      name: state.myName,
      avatar: state.myAvatar,
    };

    const zone = document.getElementById('qdTapZone');
    const statusText = document.getElementById('qdStatusText');
    zone.className = 'qd-tap-zone cheated';
    statusText.textContent = 'ë„ˆë¬´ ë¹¨ë¼ìš”!\nì‹¤ê²©!';
    statusText.style.fontSize = '32px';

  } else if(qd.phase === 'fire') {
    // ì •ìƒ ë°˜ì‘
    const reactionTime = now - qd.startTime;
    sendQDAction({ cheated: false, time: reactionTime });

    // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
    qdState.results[state.myId] = {
      cheated: false,
      time: reactionTime,
      name: state.myName,
      avatar: state.myAvatar,
    };

    const zone = document.getElementById('qdTapZone');
    const statusText = document.getElementById('qdStatusText');
    const reactionTimeEl = document.getElementById('qdReactionTime');
    zone.className = 'qd-tap-zone done';
    statusText.textContent = 'ì™„ë£Œ!';
    reactionTimeEl.textContent = (reactionTime / 1000).toFixed(3) + 'ì´ˆ';
  }
}

function sendQDAction(action) {
  const msg = {
    type: 'qd-action',
    playerId: state.myId,
    name: state.myName,
    avatar: state.myAvatar,
    cheated: action.cheated,
    time: action.time,
  };

  if(state.isHost) {
    processQDAction(msg);
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) host.send(JSON.stringify(msg));
  }
}

function processQDAction(msg) {
  if(!state.isHost) return;

  qdState.results[msg.playerId] = {
    cheated: msg.cheated,
    time: msg.time,
    name: msg.name,
    avatar: msg.avatar,
  };

  // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì‘ë‹µí–ˆëŠ”ì§€ í™•ì¸
  if(Object.keys(qdState.results).length >= state.players.length) {
    // ëª¨ë‘ ì‘ë‹µ ì™„ë£Œ
    clearTimeout(qdState.fireTimeout);
    resolveQD();
  }
}

function resolveQD() {
  if(!state.isHost) return;

  qdState.phase = 'result';

  // ìŠ¹ì ê²°ì •
  const valid = Object.entries(qdState.results)
    .filter(([id, r]) => !r.cheated)
    .sort((a, b) => a[1].time - b[1].time);

  let winnerId = null;
  let winnerName = '';
  if(valid.length > 0) {
    winnerId = valid[0][0];
    winnerName = valid[0][1].name;
  }

  const result = {
    type: 'qd-result',
    winnerId,
    winnerName,
    results: qdState.results,
    roundNum: qdState.roundNum,
  };

  broadcast(result);
  handleQDResult(result);
}

function handleQDResult(msg) {
  qdState.phase = 'result';
  qdState.results = msg.results;
  qdState.roundNum = msg.roundNum;

  renderQuickDrawView(qdState);

  // ìŠ¹ë¦¬/íŒ¨ë°° ê¸°ë¡
  const won = msg.winnerId === state.myId;
  if(msg.winnerId) {
    recordGame(won);
  }

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
  if(msg.winnerId === state.myId) {
    showToast('ğŸ† ìŠ¹ë¦¬!');
  } else if(msg.winnerId) {
    showToast(`${msg.winnerName} ìŠ¹ë¦¬!`);
  }
}

function restartQuickDraw() {
  if(!state.isHost) return;

  qdState.roundNum++;
  startQuickDraw();
}

// handleMessage í•¸ë“¤ëŸ¬ ì¶”ê°€
// ê¸°ì¡´ handleMessage í•¨ìˆ˜ì˜ handlers ê°ì²´ì— ì¶”ê°€:
/*
'qd-state': () => {
  if(msg.phase === 'fire' && navigator.vibrate) navigator.vibrate(200);
  qdState.phase = msg.phase;
  qdState.startTime = msg.startTime;
  qdState.results = msg.results;
  qdState.roundNum = msg.roundNum;
  renderQuickDrawView(qdState);
},
'qd-action': () => {
  if(state.isHost) processQDAction(msg);
},
'qd-result': () => handleQDResult(msg),
*/

// handleGameStart í•¨ìˆ˜ì— ì¶”ê°€:
/*
else if(msg.game === 'quickdraw') {
  showScreen('quickDrawGame');
  qdState = msg.state;
  renderQuickDrawView(qdState);
}
*/
