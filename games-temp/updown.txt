<!-- ========================================= -->
<!-- UP DOWN GAME -->
<!-- ========================================= -->
<div class="screen" id="updownGame">
  <div class="updown-top-bar">
    <div class="updown-title">K's Game ğŸ‘‘</div>
    <div class="updown-turn-name" id="updownTurnName">í”Œë ˆì´ì–´</div>
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">âœ•</button>
  </div>

  <div class="updown-table">
    <div class="updown-deck-count" id="updownDeckCount">ğŸƒ ë‚¨ì€ ì¹´ë“œ: 52</div>

    <div class="updown-cards-row">
      <div class="updown-card-slot" id="updownPrevCard">
        <div class="updown-card-label">ì´ì „ ì¹´ë“œ</div>
        <div class="updown-card-placeholder"></div>
      </div>

      <div class="updown-card-slot updown-current-slot" id="updownCurrentCard">
        <div class="updown-card-label">í˜„ì¬ ì¹´ë“œ</div>
        <div class="updown-card updown-card-back">
          <div class="updown-card-inner">
            <div class="updown-card-front"></div>
            <div class="updown-card-back-face">ğŸ´</div>
          </div>
        </div>
      </div>
    </div>

    <div class="updown-result" id="updownResult"></div>
  </div>

  <div class="updown-penalty-list" id="updownPenaltyList">
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:4px;font-weight:700;">ë²Œì¹™ ëª©ë¡</div>
    <div id="updownPenaltyItems"></div>
  </div>

  <div class="updown-action-area" id="updownActionArea">
    <div class="updown-choice-buttons" id="updownChoiceButtons">
      <button class="updown-btn updown-btn-up" onclick="udChoice('up')">
        <span style="font-size:28px;">â†‘</span>
        <span>UP</span>
      </button>
      <button class="updown-btn updown-btn-down" onclick="udChoice('down')">
        <span style="font-size:28px;">â†“</span>
        <span>DOWN</span>
      </button>
    </div>

    <div class="updown-bet-area">
      <input type="text" class="updown-bet-input" id="updownBetInput" placeholder="ë²Œì¹™ ë‚´ìš© ì…ë ¥..." maxlength="30">
      <button class="updown-btn-bet" onclick="udAddBet()">+Bet ë²Œì¹™</button>
    </div>
  </div>

  <!-- Special Card Areas -->
  <div class="updown-special-area updown-special-jq" id="updownSpecialJQ" style="display:none;">
    <div class="updown-special-title">ğŸ›¡ï¸ í‘ê¸°ì‚¬ ìš”ì²­</div>
    <div class="updown-special-desc">ë‹¤ë¥¸ í”Œë ˆì´ì–´ì—ê²Œ ë²Œì¹™ì„ ëŒ€ì‹  ë°›ì„ ê²ƒì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê±°ì ˆí•˜ë©´ ë‚˜ë¨¸ì§€ ëª¨ë‘ê°€ ë²Œì¹™!</div>
    <div class="updown-player-select" id="updownJQPlayerSelect"></div>
    <button class="updown-btn-special" onclick="udBlackKnight()">í‘ê¸°ì‚¬ ìš”ì²­ ğŸ›¡ï¸</button>
  </div>

  <div class="updown-special-area updown-special-k" id="updownSpecialK" style="display:none;">
    <div class="updown-special-title">ğŸ‘‘ ì™•ì˜ ëª…ë ¹</div>
    <div class="updown-special-desc">3ëª…ì—ê²Œ ë²Œì¹™ì„ ë‚´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</div>
    <div class="updown-player-select" id="updownKPlayerSelect"></div>
    <button class="updown-btn-special updown-btn-king" onclick="udKingPenalty()">ì™• ë²Œì¹™ ë¶€ì—¬ ğŸ‘‘</button>
  </div>

  <!-- Penalty Modal -->
  <div class="updown-penalty-modal" id="updownPenaltyModal">
    <div class="updown-penalty-content">
      <div class="updown-penalty-title">âŒ ë²Œì¹™!</div>
      <div class="updown-penalty-text" id="updownPenaltyText">ì†Œì£¼ 1ì”</div>
      <div class="updown-penalty-who" id="updownPenaltyWho">í”Œë ˆì´ì–´ë‹˜ì˜ ì°¨ë¡€</div>
      <button class="updown-btn-accept" onclick="udAcceptPenalty()">ìˆ˜í–‰í•˜ê¸° ğŸ˜­</button>
      <button class="updown-btn-reject" onclick="udRejectPenalty()">ê±°ì ˆ (ìˆ  ë§ˆì‹œê¸°)</button>
    </div>
  </div>

  <!-- Black Knight Request Modal -->
  <div class="updown-penalty-modal" id="updownBKModal">
    <div class="updown-penalty-content">
      <div class="updown-penalty-title">ğŸ›¡ï¸ í‘ê¸°ì‚¬ ìš”ì²­</div>
      <div class="updown-penalty-text" id="updownBKText">ë²Œì¹™ ë‚´ìš©</div>
      <div class="updown-penalty-who" id="updownBKWho">ëˆ„ê°€ ìš”ì²­í–ˆìŠµë‹ˆë‹¤</div>
      <button class="updown-btn-accept" onclick="udAcceptBK()">ìˆ˜ë½ (ëŒ€ì‹  ë°›ê¸°)</button>
      <button class="updown-btn-reject" onclick="udRejectBK()">ê±°ì ˆ (ë‚˜ë¨¸ì§€ ëª¨ë‘ ë²Œì¹™)</button>
    </div>
  </div>
</div>


/* ========================================= */
/* UP DOWN CSS */
/* ========================================= */
.updown-top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
}

.updown-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 20px;
  color: var(--gold);
}

.updown-turn-name {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent2);
}

.updown-table {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: linear-gradient(135deg, #1a5f2f, #0f4520);
  border-radius: var(--radius);
  margin: 0 12px;
  position: relative;
  min-height: 300px;
}

.updown-deck-count {
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 13px;
  font-weight: 700;
  color: rgba(255,255,255,0.7);
  background: rgba(0,0,0,0.3);
  padding: 6px 12px;
  border-radius: 20px;
}

.updown-cards-row {
  display: flex;
  gap: 20px;
  align-items: flex-end;
  margin-bottom: 20px;
}

.updown-card-slot {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.updown-current-slot {
  transform: scale(1.3);
}

.updown-card-label {
  font-size: 11px;
  font-weight: 700;
  color: rgba(255,255,255,0.6);
  text-transform: uppercase;
}

.updown-card {
  width: 70px;
  height: 100px;
  border-radius: 8px;
  position: relative;
  perspective: 1000px;
  cursor: pointer;
}

.updown-card-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.6s;
  transform-style: preserve-3d;
}

.updown-card.flipped .updown-card-inner {
  transform: rotateY(180deg);
}

.updown-card-front,
.updown-card-back-face {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 8px;
  backface-visibility: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.updown-card-front {
  background: white;
  color: #1a1a2e;
  border: 3px solid #ddd;
  font-weight: 900;
  font-size: 32px;
  transform: rotateY(180deg);
}

.updown-card-front.red {
  color: #d32f2f;
  border-color: #ffcdd2;
}

.updown-card-front.black {
  color: #1a1a2e;
  border-color: #ccc;
}

.updown-card-front .updown-card-rank {
  font-size: 32px;
  line-height: 1;
  margin-bottom: 4px;
}

.updown-card-front .updown-card-suit {
  font-size: 24px;
  line-height: 1;
}

.updown-card-back-face {
  background: linear-gradient(135deg, #8b0000, #dc143c);
  border: 3px solid #b22222;
  font-size: 48px;
  color: rgba(255,255,255,0.3);
}

.updown-card-placeholder {
  width: 70px;
  height: 100px;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  border: 2px dashed rgba(255,255,255,0.2);
}

.updown-result {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 28px;
  text-align: center;
  min-height: 40px;
  animation: resultPop 0.4s ease;
}

@keyframes resultPop {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); opacity: 1; }
}

.updown-penalty-list {
  padding: 10px 16px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  margin: 0 12px;
  max-height: 100px;
  overflow-y: auto;
}

#updownPenaltyItems {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.updown-penalty-item {
  font-size: 12px;
  color: var(--text-dim);
  padding: 4px 8px;
  background: var(--bg-surface);
  border-radius: 6px;
}

.updown-action-area {
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.updown-choice-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.updown-btn {
  padding: 20px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'Black Han Sans', sans-serif;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.updown-btn:active {
  transform: scale(0.95);
}

.updown-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.updown-btn-up {
  background: linear-gradient(135deg, #2d6a4f, #40916c);
  color: white;
}

.updown-btn-down {
  background: linear-gradient(135deg, #264653, #2a9d8f);
  color: white;
}

.updown-bet-area {
  display: flex;
  gap: 8px;
  align-items: center;
}

.updown-bet-input {
  flex: 1;
  padding: 10px 12px;
  background: var(--bg-surface);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 13px;
  font-family: inherit;
  outline: none;
}

.updown-bet-input:focus {
  border-color: var(--accent);
}

.updown-btn-bet {
  padding: 10px 16px;
  background: linear-gradient(135deg, #8b4513, #a0522d);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'Black Han Sans', sans-serif;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s;
}

.updown-btn-bet:active {
  transform: scale(0.95);
}

.updown-special-area {
  padding: 16px;
  background: var(--bg-card);
  border-radius: var(--radius);
  margin: 0 12px;
  border: 2px solid var(--accent);
  animation: specialGlow 2s ease infinite;
}

@keyframes specialGlow {
  0%, 100% { box-shadow: 0 0 10px rgba(255,107,53,0.3); }
  50% { box-shadow: 0 0 20px rgba(255,107,53,0.6); }
}

.updown-special-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 18px;
  color: var(--accent);
  margin-bottom: 6px;
}

.updown-special-desc {
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 12px;
  line-height: 1.4;
}

.updown-player-select {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 12px;
  max-height: 120px;
  overflow-y: auto;
}

.updown-player-option {
  padding: 10px 8px;
  background: var(--bg-surface);
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 12px;
  font-weight: 700;
}

.updown-player-option:active {
  transform: scale(0.95);
}

.updown-player-option.selected {
  border-color: var(--accent2);
  background: rgba(0,229,255,0.15);
}

.updown-player-option .player-avatar-sm {
  margin: 0 auto 4px;
}

.updown-btn-special {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--accent), #ff8f5a);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'Black Han Sans', sans-serif;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.15s;
}

.updown-btn-special:active {
  transform: scale(0.97);
}

.updown-btn-king {
  background: linear-gradient(135deg, #c1121f, #780000);
}

.updown-penalty-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(10,10,18,0.95);
  z-index: 150;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

.updown-penalty-modal.active {
  display: flex;
}

.updown-penalty-content {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  max-width: 360px;
  width: 100%;
  text-align: center;
  border: 2px solid var(--danger);
}

.updown-penalty-title {
  font-family: 'Black Han Sans', sans-serif;
  font-size: 32px;
  color: var(--danger);
  margin-bottom: 12px;
}

.updown-penalty-text {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
  padding: 12px;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
}

.updown-penalty-who {
  font-size: 14px;
  color: var(--text-dim);
  margin-bottom: 16px;
}

.updown-btn-accept,
.updown-btn-reject {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'Black Han Sans', sans-serif;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.15s;
  margin-bottom: 8px;
}

.updown-btn-accept {
  background: var(--bg-surface);
  color: var(--text);
  border: 1px solid rgba(255,255,255,0.1);
}

.updown-btn-reject {
  background: linear-gradient(135deg, var(--danger), #ff4569);
  color: white;
}

.updown-btn-accept:active,
.updown-btn-reject:active {
  transform: scale(0.97);
}


// ===== UP DOWN ENGINE =====

let udState = {
  deck: [],
  deckIdx: 0,
  currentCard: null,
  previousCard: null,
  turnIdx: 0,
  players: [],
  phase: 'playing', // playing, special_jq, special_k, result, penalty
  penalties: [],
  currentBet: null,
  specialData: null, // { type, requesterId, targetId(s), penaltyText }
};

function startUpDown() {
  if(!state.isHost) return;

  // Create full deck (52 cards)
  const deck = [];
  const suits = ['â™ ','â™¥','â™¦','â™£'];
  const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

  for(const suit of suits) {
    for(const rank of ranks) {
      deck.push({ rank, suit });
    }
  }

  // Shuffle
  for(let i = deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }

  udState = {
    deck,
    deckIdx: 0,
    currentCard: deck[0],
    previousCard: null,
    turnIdx: 0,
    players: state.players.map(p => ({
      id: p.id,
      name: p.name,
      avatar: p.avatar,
    })),
    phase: 'playing',
    penalties: ['ì†Œì£¼ 1ì”', 'ë§‰ê±¸ë¦¬ 1ì”', 'í­íƒ„ì£¼ 1ì”'],
    currentBet: null,
    specialData: null,
  };

  udState.deckIdx = 1;

  broadcast({ type: 'game-start', game: 'updown', state: getUpDownView() });
  showScreen('updownGame');
  renderUpDownView(getUpDownView());
}

function getUpDownView() {
  return {
    currentCard: udState.currentCard,
    previousCard: udState.previousCard,
    deckRemaining: udState.deck.length - udState.deckIdx,
    turnIdx: udState.turnIdx,
    players: udState.players,
    phase: udState.phase,
    penalties: udState.penalties,
    currentBet: udState.currentBet,
    specialData: udState.specialData,
  };
}

function broadcastUpDownState() {
  const view = getUpDownView();
  broadcast({ type: 'ud-state', state: view });
  renderUpDownView(view);
}

function renderUpDownView(view) {
  if(!view) return;

  // Update turn name
  const currentPlayer = view.players[view.turnIdx];
  document.getElementById('updownTurnName').textContent =
    currentPlayer.id === state.myId ? 'ë‚´ ì°¨ë¡€!' : currentPlayer.name + 'ì˜ ì°¨ë¡€';

  // Update deck count
  document.getElementById('updownDeckCount').textContent = `ğŸƒ ë‚¨ì€ ì¹´ë“œ: ${view.deckRemaining}`;

  // Update previous card
  const prevSlot = document.getElementById('updownPrevCard');
  if(view.previousCard) {
    prevSlot.innerHTML = `
      <div class="updown-card-label">ì´ì „ ì¹´ë“œ</div>
      ${updownCardHTML(view.previousCard, false)}
    `;
  } else {
    prevSlot.innerHTML = `
      <div class="updown-card-label">ì´ì „ ì¹´ë“œ</div>
      <div class="updown-card-placeholder"></div>
    `;
  }

  // Update current card
  const currSlot = document.getElementById('updownCurrentCard');
  currSlot.innerHTML = `
    <div class="updown-card-label">í˜„ì¬ ì¹´ë“œ</div>
    ${updownCardHTML(view.currentCard, true)}
  `;

  // Trigger flip animation
  setTimeout(() => {
    const card = currSlot.querySelector('.updown-card');
    if(card) card.classList.add('flipped');
  }, 100);

  // Update penalties list
  const penaltyItems = document.getElementById('updownPenaltyItems');
  penaltyItems.innerHTML = view.penalties.slice(-5).map(p =>
    `<div class="updown-penalty-item">ğŸº ${p}</div>`
  ).join('');

  // Update action area
  const isMyTurn = currentPlayer.id === state.myId;
  const choiceButtons = document.getElementById('updownChoiceButtons').querySelectorAll('.updown-btn');
  choiceButtons.forEach(btn => btn.disabled = !isMyTurn || view.phase !== 'playing');

  // Show/hide special areas
  document.getElementById('updownSpecialJQ').style.display = 'none';
  document.getElementById('updownSpecialK').style.display = 'none';

  if(isMyTurn && view.phase === 'special_jq') {
    showUpDownJQArea(view);
  } else if(isMyTurn && view.phase === 'special_k') {
    showUpDownKArea(view);
  }

  // Show result if any
  const resultDiv = document.getElementById('updownResult');
  if(view.phase === 'result' && view.specialData?.result) {
    resultDiv.textContent = view.specialData.result;
    resultDiv.style.color = view.specialData.correct ? 'var(--success)' : 'var(--danger)';
  } else {
    resultDiv.textContent = '';
  }
}

function updownCardHTML(card, isFlippable) {
  if(!card) return '<div class="updown-card-placeholder"></div>';

  const isRed = card.suit === 'â™¥' || card.suit === 'â™¦';
  const colorClass = isRed ? 'red' : 'black';

  if(isFlippable) {
    return `
      <div class="updown-card">
        <div class="updown-card-inner">
          <div class="updown-card-front ${colorClass}">
            <span class="updown-card-rank">${card.rank}</span>
            <span class="updown-card-suit">${card.suit}</span>
          </div>
          <div class="updown-card-back-face">ğŸ´</div>
        </div>
      </div>
    `;
  } else {
    return `
      <div class="updown-card flipped">
        <div class="updown-card-inner">
          <div class="updown-card-front ${colorClass}">
            <span class="updown-card-rank">${card.rank}</span>
            <span class="updown-card-suit">${card.suit}</span>
          </div>
          <div class="updown-card-back-face">ğŸ´</div>
        </div>
      </div>
    `;
  }
}

function udChoice(choice) {
  if(state.isHost) {
    processUpDownChoice(state.myId, choice);
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({ type: 'ud-choice', choice }));
    }
  }
}

function processUpDownChoice(playerId, choice) {
  if(!state.isHost || udState.phase !== 'playing') return;

  const playerIdx = udState.players.findIndex(p => p.id === playerId);
  if(playerIdx !== udState.turnIdx) return;

  // Get next card
  if(udState.deckIdx >= udState.deck.length) {
    showToast('ì¹´ë“œê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤!');
    return;
  }

  const nextCard = udState.deck[udState.deckIdx];
  const currentValue = getCardValue(udState.currentCard);
  const nextValue = getCardValue(nextCard);

  let correct = false;
  if(choice === 'up') {
    correct = nextValue > currentValue;
  } else if(choice === 'down') {
    correct = nextValue < currentValue;
  }

  // Same value = wrong
  if(nextValue === currentValue) correct = false;

  // Update state
  udState.previousCard = udState.currentCard;
  udState.currentCard = nextCard;
  udState.deckIdx++;

  if(correct) {
    // Correct! Move to next player
    udState.specialData = { result: 'ì •ë‹µ! âœ…', correct: true };
    udState.phase = 'result';
    broadcastUpDownState();

    setTimeout(() => {
      udState.turnIdx = (udState.turnIdx + 1) % udState.players.length;
      udState.phase = 'playing';
      udState.specialData = null;
      broadcastUpDownState();
    }, 1500);

  } else {
    // Wrong! Check for special cards
    udState.specialData = { result: 'í‹€ë ¸ë‹¤! âŒ', correct: false };

    const rank = nextCard.rank;
    if(rank === 'J' || rank === 'Q') {
      // Black Knight option
      udState.phase = 'special_jq';
      udState.specialData.type = 'jq';
      udState.specialData.requesterId = playerId;
      broadcastUpDownState();
    } else if(rank === 'K') {
      // King penalty
      udState.phase = 'special_k';
      udState.specialData.type = 'k';
      udState.specialData.kingId = playerId;
      broadcastUpDownState();
    } else {
      // Normal penalty
      udState.phase = 'penalty';
      const penaltyText = udState.currentBet || udState.penalties[Math.floor(Math.random() * udState.penalties.length)];
      showUpDownPenalty(playerId, penaltyText);
    }
  }
}

function getCardValue(card) {
  const values = { 'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13 };
  return values[card.rank] || 0;
}

function udAddBet() {
  const input = document.getElementById('updownBetInput');
  const text = input.value.trim();
  if(!text) {
    showToast('ë²Œì¹™ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }

  if(state.isHost) {
    udState.penalties.push(text);
    udState.currentBet = text;
    input.value = '';
    showToast('ë²Œì¹™ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    broadcastUpDownState();
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({ type: 'ud-addbet', text }));
    }
    input.value = '';
    showToast('ë²Œì¹™ ì¶”ê°€ ìš”ì²­!');
  }
}

function showUpDownJQArea(view) {
  const area = document.getElementById('updownSpecialJQ');
  area.style.display = 'block';

  const select = document.getElementById('updownJQPlayerSelect');
  select.innerHTML = view.players
    .filter(p => p.id !== state.myId)
    .map((p, i) => `
      <div class="updown-player-option" data-pid="${p.id}" onclick="selectUpDownPlayer('${p.id}', 'jq')">
        <div class="player-avatar-sm" style="background:${PLAYER_COLORS[i % PLAYER_COLORS.length]};">${p.avatar}</div>
        <div>${p.name}</div>
      </div>
    `).join('');
}

function showUpDownKArea(view) {
  const area = document.getElementById('updownSpecialK');
  area.style.display = 'block';

  const select = document.getElementById('updownKPlayerSelect');
  select.innerHTML = view.players
    .filter(p => p.id !== state.myId)
    .map((p, i) => `
      <div class="updown-player-option" data-pid="${p.id}" onclick="selectUpDownPlayer('${p.id}', 'k')">
        <div class="player-avatar-sm" style="background:${PLAYER_COLORS[i % PLAYER_COLORS.length]};">${p.avatar}</div>
        <div>${p.name}</div>
      </div>
    `).join('');
}

let selectedUpDownPlayers = [];

function selectUpDownPlayer(pid, type) {
  if(type === 'jq') {
    // Single selection
    selectedUpDownPlayers = [pid];
    document.querySelectorAll('#updownJQPlayerSelect .updown-player-option').forEach(el => {
      el.classList.toggle('selected', el.dataset.pid === pid);
    });
  } else if(type === 'k') {
    // Multi selection (max 3)
    if(selectedUpDownPlayers.includes(pid)) {
      selectedUpDownPlayers = selectedUpDownPlayers.filter(id => id !== pid);
    } else {
      if(selectedUpDownPlayers.length < 3) {
        selectedUpDownPlayers.push(pid);
      } else {
        showToast('ìµœëŒ€ 3ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥');
        return;
      }
    }

    document.querySelectorAll('#updownKPlayerSelect .updown-player-option').forEach(el => {
      el.classList.toggle('selected', selectedUpDownPlayers.includes(el.dataset.pid));
    });
  }
}

function udBlackKnight() {
  if(selectedUpDownPlayers.length === 0) {
    showToast('ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  const targetId = selectedUpDownPlayers[0];

  if(state.isHost) {
    processBlackKnight(state.myId, targetId);
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({ type: 'ud-special', action: 'blackknight', targetId }));
    }
  }

  selectedUpDownPlayers = [];
}

function processBlackKnight(requesterId, targetId) {
  if(!state.isHost) return;

  const penaltyText = udState.currentBet || udState.penalties[Math.floor(Math.random() * udState.penalties.length)];
  const requester = udState.players.find(p => p.id === requesterId);

  udState.specialData = {
    type: 'bk_request',
    requesterId,
    targetId,
    penaltyText,
    requesterName: requester.name,
  };

  // Send request to target
  const msg = {
    type: 'ud-bk-request',
    requesterId,
    requesterName: requester.name,
    penaltyText,
  };

  if(targetId === state.myId) {
    showUpDownBKModal(msg);
  } else {
    sendTo(targetId, msg);
  }

  showToast('í‘ê¸°ì‚¬ ìš”ì²­ ì „ì†¡!');
}

function showUpDownBKModal(data) {
  const modal = document.getElementById('updownBKModal');
  document.getElementById('updownBKText').textContent = data.penaltyText;
  document.getElementById('updownBKWho').textContent = data.requesterName + 'ë‹˜ì˜ ìš”ì²­';
  modal.classList.add('active');

  // Store for response
  modal.dataset.requesterId = data.requesterId;
  modal.dataset.penaltyText = data.penaltyText;
}

function udAcceptBK() {
  const modal = document.getElementById('updownBKModal');
  const requesterId = modal.dataset.requesterId;
  const penaltyText = modal.dataset.penaltyText;

  modal.classList.remove('active');

  if(state.isHost) {
    resolveBKAccept(requesterId, state.myId, penaltyText);
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({
        type: 'ud-bk-response',
        accepted: true,
        requesterId
      }));
    }
  }
}

function udRejectBK() {
  const modal = document.getElementById('updownBKModal');
  const requesterId = modal.dataset.requesterId;
  const penaltyText = modal.dataset.penaltyText;

  modal.classList.remove('active');

  if(state.isHost) {
    resolveBKReject(requesterId, state.myId, penaltyText);
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({
        type: 'ud-bk-response',
        accepted: false,
        requesterId
      }));
    }
  }
}

function resolveBKAccept(requesterId, acceptorId, penaltyText) {
  // Acceptor takes the penalty
  showUpDownPenalty(acceptorId, penaltyText);
  showToast('í‘ê¸°ì‚¬ê°€ ë²Œì¹™ì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
}

function resolveBKReject(requesterId, rejectId, penaltyText) {
  // Everyone except requester and rejecter gets penalty
  const targets = udState.players
    .filter(p => p.id !== requesterId && p.id !== rejectId)
    .map(p => p.id);

  targets.forEach(tid => {
    showUpDownPenalty(tid, penaltyText);
  });

  showToast('ê±°ì ˆ! ë‚˜ë¨¸ì§€ ëª¨ë‘ ë²Œì¹™!');
}

function udKingPenalty() {
  if(selectedUpDownPlayers.length === 0) {
    showToast('ìµœì†Œ 1ëª…ì„ ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  if(state.isHost) {
    processKingPenalty(state.myId, selectedUpDownPlayers);
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({
        type: 'ud-special',
        action: 'king',
        targets: selectedUpDownPlayers
      }));
    }
  }

  selectedUpDownPlayers = [];
}

function processKingPenalty(kingId, targets) {
  if(!state.isHost) return;

  const penaltyText = udState.currentBet || 'ì™•ì˜ ëª…ë ¹: ' + udState.penalties[Math.floor(Math.random() * udState.penalties.length)];

  targets.forEach(tid => {
    showUpDownPenalty(tid, penaltyText);
  });

  showToast('ì™•ì˜ ë²Œì¹™ì´ ë‚´ë ¤ì¡ŒìŠµë‹ˆë‹¤!');

  // Move to next turn
  setTimeout(() => {
    udState.turnIdx = (udState.turnIdx + 1) % udState.players.length;
    udState.phase = 'playing';
    udState.specialData = null;
    udState.currentBet = null;
    broadcastUpDownState();
  }, 2000);
}

function showUpDownPenalty(playerId, penaltyText) {
  const msg = {
    type: 'ud-penalty',
    playerId,
    penaltyText,
  };

  broadcast(msg);
  handleUpDownPenalty(msg);
}

function handleUpDownPenalty(data) {
  if(data.playerId !== state.myId) return;

  const modal = document.getElementById('updownPenaltyModal');
  document.getElementById('updownPenaltyText').textContent = data.penaltyText;
  document.getElementById('updownPenaltyWho').textContent = 'ë‹¹ì‹ ì˜ ë²Œì¹™ì…ë‹ˆë‹¤!';
  modal.classList.add('active');

  modal.dataset.penaltyText = data.penaltyText;
}

function udAcceptPenalty() {
  const modal = document.getElementById('updownPenaltyModal');
  modal.classList.remove('active');

  showToast('ë²Œì¹™ ìˆ˜í–‰! ğŸ˜­');

  if(state.isHost) {
    continueUpDown();
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({ type: 'ud-penalty-done' }));
    }
  }
}

function udRejectPenalty() {
  const modal = document.getElementById('updownPenaltyModal');
  modal.classList.remove('active');

  showToast('ìˆ  ë§ˆì‹œê¸°ë¡œ ëŒ€ì²´! ğŸº');

  if(state.isHost) {
    continueUpDown();
  } else {
    const host = Object.values(state.connections)[0];
    if(host?.open) {
      host.send(JSON.stringify({ type: 'ud-penalty-done' }));
    }
  }
}

function continueUpDown() {
  if(!state.isHost) return;

  udState.turnIdx = (udState.turnIdx + 1) % udState.players.length;
  udState.phase = 'playing';
  udState.specialData = null;
  udState.currentBet = null;
  broadcastUpDownState();
}

// ===== MESSAGE HANDLERS (Add to handleMessage function) =====

// In the handleGameStart function, add:
// else if(msg.game === 'updown') { showScreen('updownGame'); renderUpDownView(msg.state); }

// In the handleMessage function, add these cases to the handlers object:
// 'ud-state': () => { showScreen('updownGame'); renderUpDownView(msg.state); },
// 'ud-choice': () => { if(state.isHost) processUpDownChoice(peerId, msg.choice); },
// 'ud-addbet': () => { if(state.isHost) { udState.penalties.push(msg.text); udState.currentBet = msg.text; broadcastUpDownState(); } },
// 'ud-special': () => {
//   if(state.isHost) {
//     if(msg.action === 'blackknight') processBlackKnight(peerId, msg.targetId);
//     else if(msg.action === 'king') processKingPenalty(peerId, msg.targets);
//   }
// },
// 'ud-bk-request': () => showUpDownBKModal(msg),
// 'ud-bk-response': () => {
//   if(state.isHost) {
//     const penaltyText = udState.specialData?.penaltyText || 'ë²Œì¹™';
//     if(msg.accepted) resolveBKAccept(msg.requesterId, peerId, penaltyText);
//     else resolveBKReject(msg.requesterId, peerId, penaltyText);
//   }
// },
// 'ud-penalty': () => handleUpDownPenalty(msg),
// 'ud-penalty-done': () => { if(state.isHost) continueUpDown(); },
