<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>파티덱 - P2P 미니게임</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a12">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="css/games.css">
</head>
<body>

<div class="toast" id="toast"></div>

<!-- LOADING -->
<div class="screen active" id="loadingScreen">
  <div class="logo-icon">🎲</div>
  <div class="logo-title">파티덱</div>
  <div class="loading-text" id="loadingText">연결 준비 중...</div>
  <div class="loading-bar"><div class="loading-bar-inner" id="loadingBar"></div></div>
</div>

<!-- MAIN MENU -->
<div class="screen" id="mainMenu">
  <div class="logo-area">
    <div class="logo-icon">🎲</div>
    <div class="logo-title">파티덱</div>
    <div class="logo-sub">서버 없이 즐기는 P2P 미니게임</div>
  </div>

  <div class="menu-card">
    <div class="profile-section">
      <div class="avatar" id="myAvatar" onclick="cycleAvatar()">😎</div>
      <div class="profile-info">
        <input class="input-field" id="nameInput" placeholder="닉네임 입력" maxlength="8" style="padding:10px 12px; font-size:15px; font-weight:700;">
        <div class="profile-stats" id="profileStats">전적 로딩 중...</div>
      </div>
    </div>
  </div>

  <button class="btn btn-primary" onclick="createRoom()">🏠 방 만들기</button>

  <div class="join-row">
    <input class="input-field" id="joinCodeInput" placeholder="방 코드 입력" maxlength="6" style="text-transform:uppercase; text-align:center; letter-spacing:4px; font-weight:700; flex:1;">
    <button class="btn btn-accent2 btn-small" onclick="joinRoom()" style="width:auto; padding:14px 20px;">참가</button>
  </div>

  <button class="btn btn-secondary" onclick="shareApp()" style="max-width:380px;">📱 앱 공유 (QR 코드)</button>

  <div class="ad-banner">📢 광고 영역 (AdSense / AdMob)</div>
</div>

<!-- LOBBY -->
<div class="screen" id="lobby">
  <div class="lobby-header">
    <button class="back-btn" onclick="leaveLobby()">←</button>
    <div style="font-family:'Black Han Sans'; font-size:20px;">대기실</div>
    <div style="width:40px;"></div>
  </div>

  <div class="lobby-content">
    <div class="room-code-display">
      <div class="room-code-label">방 코드를 친구에게 공유하세요</div>
      <div class="room-code" id="roomCodeDisplay" onclick="copyRoomCode()">------</div>
      <div class="room-code-hint">탭하여 복사</div>
      <div class="share-btn-row">
        <button class="share-btn" onclick="copyRoomCode()">📋 코드 복사</button>
        <button class="share-btn" onclick="shareLink()">🔗 링크 공유</button>
      </div>
      <div id="qrCodeDisplay" style="margin:8px auto;width:100px;height:100px;"></div>
    </div>

  <div class="players-section">
    <div class="players-title">플레이어 (<span id="playerCount">0</span>/14)</div>
    <div class="player-list" id="playerList"></div>
  </div>

  <div class="game-select" id="gameSelectArea" style="display:none;">
    <div class="game-select-title">게임 선택 (호스트만 가능)</div>
    <div class="game-options">
      <div class="game-option selected" data-game="poker" onclick="selectGame(this)">
        <span class="game-emoji">🃏</span>포커
      </div>
      <div class="game-option" data-game="mafia" onclick="selectGame(this)">
        <span class="game-emoji">🕵️</span>마피아
      </div>
      <div class="game-option" data-game="sutda" onclick="selectGame(this)">
        <span class="game-emoji">🎴</span>섯다
      </div>
      <div class="game-option" data-game="quickdraw" onclick="selectGame(this)">
        <span class="game-emoji">🤠</span>총잡이
      </div>
      <div class="game-option" data-game="roulette" onclick="selectGame(this)">
        <span class="game-emoji">🔫</span>룰렛
      </div>
      <div class="game-option" data-game="racing" onclick="selectGame(this)">
        <span class="game-emoji">🏍️</span>레이싱
      </div>
      <div class="game-option" data-game="lottery" onclick="selectGame(this)">
        <span class="game-emoji">🎰</span>뽑기
      </div>
      <div class="game-option" data-game="ecard" onclick="selectGame(this)">
        <span class="game-emoji">👑</span>E카드
      </div>
      <div class="game-option" data-game="yahtzee" onclick="selectGame(this)">
        <span class="game-emoji">🎲</span>야추
      </div>
      <div class="game-option" data-game="updown" onclick="selectGame(this)">
        <span class="game-emoji">🃏</span>업다운
      </div>
      <div class="game-option" data-game="truth" onclick="selectGame(this)">
        <span class="game-emoji">⭕</span>진실게임
      </div>
    </div>
  </div>

  <div id="waitingMsg" style="text-align:center; color:var(--text-dim); font-size:13px; padding:16px 0;">
    <div class="spinner"></div>
    <div style="margin-top:8px;" id="waitingText">호스트가 게임을 시작하길 대기 중...</div>
  </div>
  <div id="connectionStatus" style="text-align:center; padding:8px; font-size:12px; border-radius:8px; margin-top:4px; display:none;"></div>
  </div>

  <div class="lobby-footer">
    <button class="btn btn-primary" id="startGameBtn" style="display:none;" onclick="startGame()">🎮 게임 시작</button>
  </div>
</div>

<!-- POKER -->
<div class="screen" id="pokerGame">
  <div class="poker-top-bar">
    <div class="pot-display">💰 <span id="potAmount">0</span></div>
    <div class="round-display" id="roundDisplay">프리플랍</div>
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">✕</button>
  </div>
  <div class="opponents-area" id="opponentsArea"></div>
  <div class="table-area">
    <div class="community-cards" id="communityCards"></div>
  </div>
  <div class="my-hand-area">
    <div class="my-info-row">
      <div class="my-chips" id="myChipsDisplay">💰 1000</div>
      <div class="my-hand-label">내 패</div>
    </div>
    <div class="my-cards" id="myCardsDisplay"></div>
    <div class="hand-rank-display" id="handRankDisplay"></div>
  </div>
  <div class="raise-slider-area" id="raiseSliderArea">
    <input type="range" class="raise-slider" id="raiseSlider" min="0" max="1000" value="100">
    <div class="raise-amount" id="raiseAmountDisplay">100</div>
    <button class="raise-confirm" onclick="confirmRaise()">확인</button>
  </div>
  <div class="action-bar" id="actionBar">
    <button class="action-btn btn-fold" onclick="pokerAction('fold')">폴드</button>
    <button class="action-btn btn-check" id="checkCallBtn" onclick="pokerAction('check')">체크</button>
    <button class="action-btn btn-raise" onclick="showRaiseSlider()">레이즈</button>
    <button class="action-btn btn-allin" onclick="pokerAction('allin')">올인</button>
  </div>
</div>

<!-- MAFIA FULL VERSION -->
<div class="screen" id="mafiaGame">
  <!-- Top Bar -->
  <div class="mf-topbar">
    <div class="mf-topbar-left">
      <button class="mf-back-btn" onclick="mfLeaveGame()">✕</button>
      <div class="mf-phase-badge day" id="mfPhaseBadge">
        <span id="mfPhaseIcon">☀️</span>
        <span id="mfPhaseText">낮</span>
      </div>
    </div>
    <div class="mf-day-counter" id="mfDayCounter">1일차</div>
    <div class="mf-timer-box" id="mfTimerBox">
      <span>⏱</span>
      <span id="mfTimer">180</span>
    </div>
  </div>

  <!-- Role Banner -->
  <div class="mf-role-banner team-citizen" id="mfRoleBanner">
    <div class="mf-role-emoji" id="mfRoleEmoji">👤</div>
    <div class="mf-role-info">
      <div class="mf-role-name citizen-color" id="mfRoleName">시민</div>
      <div class="mf-role-desc" id="mfRoleDesc">마피아를 찾아 투표하세요</div>
    </div>
  </div>

  <!-- Main Scrollable Content -->
  <div class="mf-content" id="mfContent">
    <!-- Dynamic content injected by JS:
         - Player grid
         - Night action panel
         - Chat panel (mafia/spy)
         - Vote status panel
         - Events list
         - Spectator mode
         - Lover reveal
         etc.
    -->
  </div>

  <!-- Bottom Action Area -->
  <div class="mf-action-area" id="mfActionArea">
    <div class="mf-message-box" id="mfMessageBox"></div>
    <div class="mf-btn-row" id="mfBtnRow">
      <!-- Buttons injected dynamically -->
    </div>
  </div>

  <!-- Result Overlay (hidden by default) -->
  <div class="mf-result-overlay" id="mfResultOverlay" style="display:none;">
    <div class="mf-result-title" id="mfResultTitle"></div>
    <div class="mf-result-subtitle" id="mfResultSubtitle"></div>
    <div class="mf-result-roles" id="mfResultRoles"></div>
    <button class="mf-result-close-btn" onclick="mfCloseResult()">로비로 돌아가기</button>
  </div>
</div>

<!-- TRUTH GAME -->
<div class="screen" id="truthGame">
  <!-- 상단 바 -->
  <div class="truth-top-bar">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">✕</button>
    <div class="truth-round-display">
      <span class="truth-round-badge" id="truthRoundBadge">ROUND 1</span>
    </div>
    <div class="truth-questioner-display" id="truthQuestionerDisplay">질문자: ---</div>
  </div>

  <!-- 메인 콘텐츠 영역 -->
  <div class="truth-content">

    <!-- Phase: question (질문자 입력) -->
    <div class="truth-phase-area" id="truthQuestionInputArea" style="display:none;">
      <div class="truth-your-turn-badge">✨ 당신의 차례입니다</div>
      <div class="truth-question-box">
        <textarea
          class="truth-textarea"
          id="truthQuestionInput"
          placeholder="질문을 입력하세요...&#10;예: 여기서 OO를 이성적으로 좋아하는 사람이 있다?"
          maxlength="200"
          rows="3"
        ></textarea>
        <div class="truth-char-count"><span id="truthCharCount">0</span>/200</div>
      </div>
      <button class="btn btn-primary truth-submit-btn" onclick="submitTruthQuestion()">
        📨 질문 제출
      </button>
    </div>

    <!-- Phase: question (대기 화면 - 질문자가 아닌 경우) -->
    <div class="truth-phase-area" id="truthWaitQuestionArea" style="display:none;">
      <div class="truth-waiting-icon">🤔</div>
      <div class="truth-waiting-text" id="truthWaitingText">질문을 기다리는 중...</div>
      <div class="truth-waiting-sub" id="truthWaitingSubText">질문자가 질문을 작성하고 있습니다</div>
      <div class="truth-dots-loader">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- Phase: voting (질문 표시 + O/X 투표) -->
    <div class="truth-phase-area" id="truthVotingArea" style="display:none;">
      <div class="truth-question-display">
        <div class="truth-question-label">Q.</div>
        <div class="truth-question-text" id="truthQuestionText">질문 내용</div>
      </div>

      <!-- 투표 버튼 영역 -->
      <div class="truth-vote-buttons" id="truthVoteButtons">
        <button class="truth-vote-btn truth-vote-o" id="truthBtnO" onclick="castTruthVote('O')">
          <span class="truth-vote-symbol">O</span>
          <span class="truth-vote-label">예</span>
        </button>
        <button class="truth-vote-btn truth-vote-x" id="truthBtnX" onclick="castTruthVote('X')">
          <span class="truth-vote-symbol">✕</span>
          <span class="truth-vote-label">아니오</span>
        </button>
      </div>

      <!-- 투표 완료 후 대기 -->
      <div class="truth-vote-waiting" id="truthVoteWaiting" style="display:none;">
        <div class="truth-voted-badge" id="truthVotedBadge">✅ 투표 완료</div>
        <div class="truth-vote-progress">
          <div class="truth-progress-bar">
            <div class="truth-progress-fill" id="truthProgressFill" style="width:0%"></div>
          </div>
          <div class="truth-progress-text" id="truthProgressText">투표 중... (0/0명 완료)</div>
        </div>
      </div>
    </div>

    <!-- Phase: result (결과 표시) -->
    <div class="truth-phase-area" id="truthResultArea" style="display:none;">
      <div class="truth-question-display truth-question-display-small">
        <div class="truth-question-label">Q.</div>
        <div class="truth-question-text" id="truthResultQuestionText">질문 내용</div>
      </div>

      <div class="truth-result-container">
        <div class="truth-result-title">투표 결과</div>

        <!-- O 결과 -->
        <div class="truth-result-row">
          <div class="truth-result-icon truth-result-icon-o">O</div>
          <div class="truth-result-info">
            <div class="truth-result-count" id="truthResultOCount">0명</div>
            <div class="truth-result-dots" id="truthResultODots"></div>
          </div>
        </div>

        <!-- X 결과 -->
        <div class="truth-result-row">
          <div class="truth-result-icon truth-result-icon-x">✕</div>
          <div class="truth-result-info">
            <div class="truth-result-count" id="truthResultXCount">0명</div>
            <div class="truth-result-dots" id="truthResultXDots"></div>
          </div>
        </div>

        <!-- 총원 -->
        <div class="truth-result-total" id="truthResultTotal">총 0명 참여</div>
      </div>

      <!-- 다음 질문 버튼 (질문자 또는 호스트) -->
      <button class="btn btn-accent2 truth-next-btn" id="truthNextBtn" onclick="truthNextRound()" style="display:none;">
        ➡️ 다음 질문
      </button>
      <div class="truth-next-waiting" id="truthNextWaiting" style="display:none;">
        다음 질문을 기다리는 중...
      </div>
    </div>

  </div>

  <!-- 하단 플레이어 표시 -->
  <div class="truth-players-bar" id="truthPlayersBar"></div>
</div>

<!-- QUICK DRAW GAME -->
<div class="screen" id="quickDrawGame">
  <div class="qd-header">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">✕</button>
    <div class="qd-title">🤠 서부 총잡이</div>
    <div class="qd-round">라운드 <span id="qdRoundNum">1</span></div>
  </div>

  <div class="qd-main-area">
    <div class="qd-tap-zone" id="qdTapZone" onclick="qdTap()">
      <div class="qd-status-text" id="qdStatusText">준비...</div>
      <div class="qd-reaction-time" id="qdReactionTime"></div>
    </div>
  </div>

  <div class="qd-rankings">
    <div class="qd-rankings-title">순위</div>
    <div class="qd-rankings-list" id="qdRankingsList"></div>
  </div>

  <button class="btn btn-primary qd-restart-btn" id="qdRestartBtn" style="display:none;" onclick="restartQuickDraw()">다시 하기</button>
</div>

<!-- RUSSIAN ROULETTE -->
<div class="screen" id="rouletteGame">
  <div class="roulette-header">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">✕</button>
    <div class="roulette-title">🔫 러시안 룰렛</div>
    <div class="roulette-survivors">
      <span id="rouletteSurvivors">6</span>/<span id="rouletteTotalPlayers">6</span>
    </div>
  </div>

  <!-- 게임 시작 전 설정 (호스트만) -->
  <div class="roulette-setup" id="rouletteSetup" style="display:none;">
    <div class="setup-card">
      <div class="setup-label">총알 개수</div>
      <div class="setup-slider-row">
        <input type="range" class="setup-slider" id="bulletsSlider" min="1" max="3" value="1">
        <div class="setup-value" id="bulletsValue">1</div>
      </div>
    </div>
    <div class="setup-card">
      <div class="setup-label">실린더 칸 수</div>
      <div class="setup-slider-row">
        <input type="range" class="setup-slider" id="chambersSlider" min="6" max="8" value="6">
        <div class="setup-value" id="chambersValue">6</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="confirmRouletteSetup()" style="margin-top:12px;">설정 완료 및 시작</button>
  </div>

  <!-- 실린더 시각화 -->
  <div class="cylinder-area">
    <div class="current-turn-display" id="currentTurnDisplay">
      <span id="currentTurnName">플레이어</span>의 차례
    </div>

    <div class="cylinder-container">
      <div class="cylinder" id="cylinder">
        <!-- 동적 생성: 6~8개 칸 -->
      </div>
      <div class="cylinder-center">🎯</div>
    </div>

    <div class="cylinder-info" id="cylinderInfo">
      실린더를 돌려주세요
    </div>
  </div>

  <!-- 생존자 리스트 -->
  <div class="survivors-list" id="survivorsList">
    <!-- 동적 생성 -->
  </div>

  <!-- 액션 버튼 -->
  <div class="roulette-actions" id="rouletteActions">
    <button class="btn btn-secondary" id="spinBtn" onclick="spinCylinder()" style="display:none;">
      🔄 실린더 돌리기
    </button>
    <button class="btn btn-danger" id="triggerBtn" onclick="pullTrigger()" style="display:none;">
      💥 방아쇠 당기기
    </button>
    <button class="btn btn-primary" id="restartBtn" onclick="restartRoulette()" style="display:none;">
      🔁 다시 하기
    </button>
  </div>
</div>

<!-- 결과 플래시 오버레이 -->
<div class="roulette-flash" id="rouletteFlash">
  <div class="flash-content" id="flashContent">
    <div class="flash-icon" id="flashIcon">💥</div>
    <div class="flash-text" id="flashText">탕!</div>
  </div>
</div>

<!-- LOTTERY & ROULETTE GAME -->
<div class="screen" id="lotteryGame">
  <!-- Top Bar -->
  <div class="lottery-top-bar">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">✕</button>
    <div class="lottery-title">🎰 뽑기 & 룰렛</div>
    <div style="width:40px;"></div>
  </div>

  <!-- Mode Tabs -->
  <div class="mode-tabs">
    <div class="mode-tab active" data-mode="lottery" onclick="switchLotteryMode('lottery')">
      📋 종이뽑기
    </div>
    <div class="mode-tab" data-mode="roulette" onclick="switchLotteryMode('roulette')">
      🎡 룰렛
    </div>
  </div>

  <!-- LOTTERY MODE -->
  <div class="lottery-mode-container" id="lotteryModeContainer">
    <!-- Setup Panel (Host Only) -->
    <div class="lottery-setup-panel" id="lotterySetupPanel" style="display:none;">
      <div class="setup-title">🎯 뽑기 항목 설정 (호스트만 가능)</div>
      <textarea class="lottery-items-input" id="lotteryItemsInput" placeholder="항목을 줄바꿈으로 구분하여 입력하세요&#10;예:&#10;당첨!&#10;꽝&#10;벌칙: 원샷&#10;벌칙: 춤추기&#10;행운!&#10;다시 뽑기"></textarea>
      <div class="setup-row">
        <label style="color:var(--text);font-size:14px;font-weight:700;">칸 개수:</label>
        <select class="grid-size-select" id="gridSizeSelect">
          <option value="4">4x4 (16칸)</option>
          <option value="5">5x5 (25칸)</option>
          <option value="6">6x6 (36칸)</option>
          <option value="8">8x8 (64칸)</option>
          <option value="10" selected>10x10 (100칸)</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="startLotteryGame()">🎮 뽑기 시작</button>
    </div>

    <!-- Lottery Grid -->
    <div class="lottery-grid-container" id="lotteryGridContainer" style="display:none;">
      <div class="lottery-status">
        <div class="status-text">🎯 칸을 터치하여 뽑기!</div>
        <div class="picked-count">뽑은 개수: <span id="pickedCount">0</span> / <span id="totalCount">100</span></div>
      </div>
      <div class="lottery-grid" id="lotteryGrid"></div>
    </div>

    <!-- My Result Display -->
    <div class="my-result-panel" id="myLotteryResult" style="display:none;">
      <div class="result-label">🎁 내가 뽑은 결과</div>
      <div class="result-list" id="myResultList"></div>
    </div>
  </div>

  <!-- ROULETTE MODE -->
  <div class="roulette-mode-container" id="rouletteModeContainer" style="display:none;">
    <!-- Setup Panel (Host Only) -->
    <div class="roulette-setup-panel" id="rouletteSetupPanel" style="display:none;">
      <div class="setup-title">🎡 룰렛 항목 설정 (호스트만 가능)</div>
      <textarea class="lottery-items-input" id="rouletteItemsInput" placeholder="룰렛 항목을 줄바꿈으로 구분 (2~12개)&#10;예:&#10;당첨!&#10;벌칙 1&#10;꽝&#10;원샷&#10;행운&#10;다시!"></textarea>
      <button class="btn btn-primary" onclick="startRouletteGame()">🎡 룰렛 시작</button>
    </div>

    <!-- Roulette Display -->
    <div class="roulette-display-container" id="rouletteDisplayContainer" style="display:none;">
      <div class="roulette-status">
        <div class="status-text">🎰 돌리기 버튼을 눌러주세요!</div>
      </div>

      <div class="roulette-wheel-container">
        <div class="roulette-pointer">▼</div>
        <div class="roulette-wheel" id="rouletteWheel">
          <canvas id="rouletteCanvas" width="300" height="300"></canvas>
        </div>
      </div>

      <button class="btn btn-primary roulette-spin-btn" id="rouletteSpinBtn" onclick="spinRoulette()">
        🎡 돌리기!
      </button>

      <!-- Result Display -->
      <div class="roulette-result-display" id="rouletteResultDisplay" style="display:none;">
        <div class="result-emoji">🎉</div>
        <div class="result-text" id="rouletteResultText">당첨!</div>
      </div>
    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- UP DOWN GAME -->
<!-- ========================================= -->
<div class="screen" id="updownGame">
  <div class="updown-top-bar">
    <div class="updown-title">K's Game</div>
    <div class="updown-turn-name" id="updownTurnName">플레이어</div>
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">&#10005;</button>
  </div>

  <div class="updown-table">
    <div class="updown-deck-count" id="updownDeckCount">남은 카드: 52</div>

    <div class="updown-cards-row">
      <div class="updown-card-slot" id="updownPrevCard">
        <div class="updown-card-label">이전 카드</div>
        <div class="updown-card-placeholder"></div>
      </div>

      <div class="updown-card-slot updown-current-slot" id="updownCurrentCard">
        <div class="updown-card-label">현재 카드</div>
        <div class="updown-card updown-card-back">
          <div class="updown-card-inner">
            <div class="updown-card-front"></div>
            <div class="updown-card-back-face">&#127924;</div>
          </div>
        </div>
      </div>
    </div>

    <div class="updown-result" id="updownResult"></div>
  </div>

  <div class="updown-penalty-list" id="updownPenaltyList">
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:4px;font-weight:700;">벌칙 목록</div>
    <div id="updownPenaltyItems"></div>
  </div>

  <div class="updown-action-area" id="updownActionArea">
    <div class="updown-choice-buttons" id="updownChoiceButtons">
      <button class="updown-btn updown-btn-up" onclick="udChoice('up')">
        <span style="font-size:28px;">&#8593;</span>
        <span>UP</span>
      </button>
      <button class="updown-btn updown-btn-down" onclick="udChoice('down')">
        <span style="font-size:28px;">&#8595;</span>
        <span>DOWN</span>
      </button>
    </div>

    <div class="updown-bet-area">
      <input type="text" class="updown-bet-input" id="updownBetInput" placeholder="벌칙 내용 입력..." maxlength="30">
      <button class="updown-btn-bet" onclick="udAddBet()">+Bet 벌칙</button>
    </div>
  </div>

  <!-- Special Card Areas -->
  <div class="updown-special-area updown-special-jq" id="updownSpecialJQ" style="display:none;">
    <div class="updown-special-title">흑기사 요청</div>
    <div class="updown-special-desc">다른 플레이어에게 벌칙을 대신 받을 것을 요청할 수 있습니다. 거절하면 나머지 모두가 벌칙!</div>
    <div class="updown-player-select" id="updownJQPlayerSelect"></div>
    <button class="updown-btn-special" onclick="udBlackKnight()">흑기사 요청</button>
  </div>

  <div class="updown-special-area updown-special-k" id="updownSpecialK" style="display:none;">
    <div class="updown-special-title">왕의 명령</div>
    <div class="updown-special-desc">3명에게 벌칙을 내릴 수 있습니다!</div>
    <div class="updown-player-select" id="updownKPlayerSelect"></div>
    <button class="updown-btn-special updown-btn-king" onclick="udKingPenalty()">왕 벌칙 부여</button>
  </div>

  <!-- Penalty Modal -->
  <div class="updown-penalty-modal" id="updownPenaltyModal">
    <div class="updown-penalty-content">
      <div class="updown-penalty-title">벌칙!</div>
      <div class="updown-penalty-text" id="updownPenaltyText">소주 1잔</div>
      <div class="updown-penalty-who" id="updownPenaltyWho">플레이어님의 차례</div>
      <button class="updown-btn-accept" onclick="udAcceptPenalty()">수행하기</button>
      <button class="updown-btn-reject" onclick="udRejectPenalty()">거절 (술 마시기)</button>
    </div>
  </div>

  <!-- Black Knight Request Modal -->
  <div class="updown-penalty-modal" id="updownBKModal">
    <div class="updown-penalty-content">
      <div class="updown-penalty-title">흑기사 요청</div>
      <div class="updown-penalty-text" id="updownBKText">벌칙 내용</div>
      <div class="updown-penalty-who" id="updownBKWho">누가 요청했습니다</div>
      <button class="updown-btn-accept" onclick="udAcceptBK()">수락 (대신 받기)</button>
      <button class="updown-btn-reject" onclick="udRejectBK()">거절 (나머지 모두 벌칙)</button>
    </div>
  </div>
</div>

<!-- ============================== -->
<!-- YAHTZEE GAME -->
<!-- ============================== -->
<div class="screen" id="yahtzeeGame">
  <div class="yahtzee-header">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">&#10005;</button>
    <div class="yahtzee-turn-info">
      <div class="yahtzee-turn-text" id="yahTurnText">턴 1/13</div>
      <div class="yahtzee-current-player" id="yahCurrentPlayer">플레이어 차례</div>
    </div>
    <div class="yahtzee-rolls-left" id="yahRollsLeft">3 left</div>
  </div>

  <div class="yahtzee-players-bar" id="yahtzeePlayersBar">
  </div>

  <div class="yahtzee-dice-area">
    <!-- Three.js 3D viewport -->
    <div id="yahtzeeThreeContainer">
      <canvas id="yahtzeeCanvas"></canvas>
      <div class="yahtzee-combo-label" id="yahtzeeComboLabel"></div>
    </div>

    <!-- Bottom hold bar: held dice shown as HTML cards -->
    <div class="yahtzee-hold-bar" id="yahtzeeHoldBar">
      <!-- Dynamically populated: clickable held-die elements -->
    </div>

    <div class="yahtzee-roll-hint">탭하여 주사위 선택/해제</div>
    <button class="btn btn-primary yahtzee-roll-btn" id="yahtzeeRollBtn" onclick="yahRoll()">주사위 굴리기</button>
  </div>

  <div class="yahtzee-scorecard-area">
    <div class="yahtzee-scorecard-title">점수표</div>
    <div class="yahtzee-scorecard" id="yahtzeeScorecard">
      <table class="yahtzee-score-table">
        <thead>
          <tr>
            <th>카테고리</th>
            <th>점수</th>
          </tr>
        </thead>
        <tbody>
          <tr class="yahtzee-score-row" data-cat="ones">
            <td class="yahtzee-cat-name">1s (Ones)</td>
            <td class="yahtzee-cat-score" id="yahcat-ones">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="twos">
            <td class="yahtzee-cat-name">2s (Twos)</td>
            <td class="yahtzee-cat-score" id="yahcat-twos">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="threes">
            <td class="yahtzee-cat-name">3s (Threes)</td>
            <td class="yahtzee-cat-score" id="yahcat-threes">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="fours">
            <td class="yahtzee-cat-name">4s (Fours)</td>
            <td class="yahtzee-cat-score" id="yahcat-fours">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="fives">
            <td class="yahtzee-cat-name">5s (Fives)</td>
            <td class="yahtzee-cat-score" id="yahcat-fives">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="sixes">
            <td class="yahtzee-cat-name">6s (Sixes)</td>
            <td class="yahtzee-cat-score" id="yahcat-sixes">-</td>
          </tr>
          <tr class="yahtzee-subtotal-row">
            <td><strong>상단 합계</strong></td>
            <td id="yahcat-upper-subtotal">0</td>
          </tr>
          <tr class="yahtzee-bonus-row">
            <td><strong>보너스 (63+ 시)</strong></td>
            <td id="yahcat-bonus">0</td>
          </tr>
          <tr class="yahtzee-divider-row">
            <td colspan="2"></td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="three-kind">
            <td class="yahtzee-cat-name">3 of a Kind</td>
            <td class="yahtzee-cat-score" id="yahcat-three-kind">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="four-kind">
            <td class="yahtzee-cat-name">4 of a Kind</td>
            <td class="yahtzee-cat-score" id="yahcat-four-kind">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="full-house">
            <td class="yahtzee-cat-name">Full House (25점)</td>
            <td class="yahtzee-cat-score" id="yahcat-full-house">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="small-straight">
            <td class="yahtzee-cat-name">Small Straight (30점)</td>
            <td class="yahtzee-cat-score" id="yahcat-small-straight">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="large-straight">
            <td class="yahtzee-cat-name">Large Straight (40점)</td>
            <td class="yahtzee-cat-score" id="yahcat-large-straight">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="yahtzee">
            <td class="yahtzee-cat-name">Yahtzee! (50점)</td>
            <td class="yahtzee-cat-score" id="yahcat-yahtzee">-</td>
          </tr>
          <tr class="yahtzee-score-row" data-cat="chance">
            <td class="yahtzee-cat-name">Chance</td>
            <td class="yahtzee-cat-score" id="yahcat-chance">-</td>
          </tr>
          <tr class="yahtzee-total-row">
            <td><strong>총점</strong></td>
            <td id="yahcat-total"><strong>0</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button class="btn yahtzee-score-btn" id="yahtzeeScoreBtn" onclick="yahScore()" style="display:none;">점수 확정</button>
  </div>

  <div class="yahtzee-game-over" id="yahtzeeGameOver" style="display:none;">
    <div class="yahtzee-final-scores">
      <div class="yahtzee-final-title">게임 종료!</div>
      <div class="yahtzee-rankings" id="yahtzeeRankings">
      </div>
    </div>
    <button class="btn btn-primary" onclick="closeYahtzeeGame()" style="max-width:280px;">대기실로</button>
  </div>
</div>


<!-- ===== E CARD GAME ===== -->
<div class="screen" id="ecardGame">
  <div class="ecard-top-bar">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">&#10005;</button>
    <div class="ecard-title">E카드 (왕과 노예)</div>
    <div class="ecard-round">라운드 <span id="ecardRound">1</span>/5</div>
  </div>

  <div class="ecard-score">
    <div class="score-item score-emperor">
      <div class="score-icon">&#128081;</div>
      <div class="score-value" id="ecardScoreEmperor">0</div>
    </div>
    <div class="score-divider">:</div>
    <div class="score-item score-slave">
      <div class="score-icon">&#9939;&#65039;</div>
      <div class="score-value" id="ecardScoreSlave">0</div>
    </div>
  </div>

  <div class="ecard-role-display" id="ecardRoleDisplay">
    <div class="role-badge" id="ecardRoleBadge">
      <div class="role-icon" id="ecardRoleIcon">&#128081;</div>
      <div class="role-text">당신은 <span id="ecardRoleName">황제</span>입니다</div>
    </div>
  </div>

  <div class="ecard-opponent-area" id="ecardOpponentArea">
    <div class="opponent-info">
      <div class="opponent-avatar" id="ecardOppAvatar" style="background: linear-gradient(135deg, #00e5ff, #00b8d4);">&#128526;</div>
      <div class="opponent-name" id="ecardOppName">상대방</div>
      <div class="opponent-cards-count">남은 카드: <span id="ecardOppCardsCount">5</span>장</div>
    </div>
    <div class="opponent-played-card" id="ecardOppPlayedCard">
    </div>
  </div>

  <div class="ecard-battle-area" id="ecardBattleArea" style="display:none;">
    <div class="battle-card" id="ecardBattleOpp"></div>
    <div class="battle-vs">VS</div>
    <div class="battle-card" id="ecardBattleMy"></div>
  </div>

  <div class="ecard-result-text" id="ecardResultText"></div>

  <div class="ecard-my-cards-area">
    <div class="my-cards-label">내 카드 (<span id="ecardMyCardsCount">5</span>장)</div>
    <div class="ecard-cards-hand" id="ecardMyCards">
    </div>
  </div>

  <div class="ecard-bet-area" id="ecardBetArea" style="display:none;">
    <div class="bet-label">배팅 금액 제안</div>
    <div class="bet-controls">
      <input type="range" class="bet-slider" id="ecardBetSlider" min="10" max="500" value="100" step="10">
      <div class="bet-amount" id="ecardBetAmount">100</div>
    </div>
    <button class="btn btn-primary" id="ecardBetSubmit" onclick="ecardSubmitBet()">배팅 제안</button>
  </div>

  <div class="ecard-bet-response" id="ecardBetResponse" style="display:none;">
    <div class="bet-proposal">상대방이 <span id="ecardBetProposed">100</span> 배팅을 제안했습니다</div>
    <div class="bet-buttons">
      <button class="btn btn-secondary" onclick="ecardRejectBet()">거절</button>
      <button class="btn btn-primary" onclick="ecardAcceptBet()">수락</button>
    </div>
  </div>

  <div class="ecard-action-buttons" id="ecardActionButtons">
    <button class="btn btn-primary" id="ecardSubmitBtn" onclick="ecardSubmitCard()" disabled>카드 제출</button>
  </div>

  <div class="ecard-waiting" id="ecardWaiting" style="display:none;">
    <div class="spinner"></div>
    <div style="margin-top:8px;font-size:14px;color:var(--text-dim);" id="ecardWaitingText">상대방을 기다리는 중...</div>
  </div>
</div>

<!-- SUTDA GAME -->
<div class="screen" id="sutdaGame">
  <!-- 상단 바 -->
  <div class="sutda-top-bar">
    <button class="back-btn" style="font-size:18px;padding:4px;" onclick="leaveGame()">&#10005;</button>
    <div class="sutda-title-area">
      <span class="sutda-title-text">장땡 섯다</span>
      <span class="sutda-pot-badge" id="sutdaPotBadge">0</span>
    </div>
    <div class="sutda-my-balance" id="sutdaMyBalance">0</div>
  </div>

  <!-- 상대방 영역 -->
  <div class="sutda-opponents" id="sutdaOpponents"></div>

  <!-- 테이블 중앙 -->
  <div class="sutda-table">
    <div class="sutda-table-felt">
      <div class="sutda-pot-center">
        <div class="sutda-pot-label">판돈</div>
        <div class="sutda-pot-amount" id="sutdaPotAmount">0</div>
      </div>
      <div class="sutda-turn-indicator" id="sutdaTurnIndicator"></div>
    </div>
  </div>

  <!-- 내 패 영역 -->
  <div class="sutda-my-area">
    <div class="sutda-my-info">
      <div class="sutda-my-name" id="sutdaMyName">나</div>
      <div class="sutda-my-chips" id="sutdaMyChips">0</div>
    </div>
    <div class="sutda-my-cards" id="sutdaMyCards"></div>
    <div class="sutda-my-rank" id="sutdaMyRank"></div>
  </div>

  <!-- 세륙 선택 패널 -->
  <div class="sutda-seryuk-panel" id="sutdaSeryukPanel" style="display:none;">
    <div class="sutda-seryuk-title">세륙 (6+4) 선택</div>
    <div class="sutda-seryuk-desc">밀기: 10끗으로 계산 | 깽판: 패 재분배</div>
    <div class="sutda-seryuk-buttons">
      <button class="sutda-seryuk-btn sutda-seryuk-push" onclick="sutdaSeryukChoice('push')">
        <span class="sutda-seryuk-icon">&#x1F4AA;</span>
        <span>밀기</span>
        <span class="sutda-seryuk-sub">10끗</span>
      </button>
      <button class="sutda-seryuk-btn sutda-seryuk-chaos" onclick="sutdaSeryukChoice('chaos')">
        <span class="sutda-seryuk-icon">&#x1F300;</span>
        <span>깽판</span>
        <span class="sutda-seryuk-sub">패 재분배</span>
      </button>
    </div>
  </div>

  <!-- 배팅 버튼 -->
  <div class="sutda-action-bar" id="sutdaActionBar">
    <button class="sutda-bet-btn sutda-bet-10k" onclick="sutdaBet('raise',10000)" id="sutdaBtn10k">+1만</button>
    <button class="sutda-bet-btn sutda-bet-50k" onclick="sutdaBet('raise',50000)" id="sutdaBtn50k">+5만</button>
    <button class="sutda-bet-btn sutda-bet-100k" onclick="sutdaBet('raise',100000)" id="sutdaBtn100k">+10만</button>
    <button class="sutda-bet-btn sutda-bet-call" onclick="sutdaBet('call',0)" id="sutdaBtnCall">콜</button>
    <button class="sutda-bet-btn sutda-bet-die" onclick="sutdaBet('die',0)" id="sutdaBtnDie">다이</button>
    <button class="sutda-bet-btn sutda-bet-allin" onclick="sutdaBet('allin',0)" id="sutdaBtnAllin">올인</button>
  </div>

  <!-- 결과 오버레이 -->
  <div class="sutda-result-overlay" id="sutdaResultOverlay">
    <div class="sutda-result-box">
      <div class="sutda-result-title" id="sutdaResultTitle">승리!</div>
      <div class="sutda-result-winner" id="sutdaResultWinner"></div>
      <div class="sutda-result-rank" id="sutdaResultRank"></div>
      <div class="sutda-result-cards" id="sutdaResultCards"></div>
      <div class="sutda-result-pot" id="sutdaResultPot"></div>
      <div class="sutda-result-all-hands" id="sutdaResultAllHands"></div>
      <button class="btn btn-primary" onclick="closeSutdaResult()" style="margin-top:16px;">확인</button>
    </div>
  </div>
</div>

<!-- RACING GAME -->
<div class="screen" id="racingGame">
  <!-- 모드 선택 화면 -->
  <div class="racing-mode-select" id="racingModeSelect">
    <div class="racing-mode-header">
      <button class="back-btn" onclick="leaveGame()">←</button>
      <div class="racing-mode-title">🏍️ 오토바이 레이싱</div>
      <div style="width:40px;"></div>
    </div>

    <div class="racing-mode-cards">
      <div class="racing-mode-card" onclick="selectRacingMode('survival')">
        <div class="racing-mode-icon">⚡</div>
        <div class="racing-mode-name">서바이벌</div>
        <div class="racing-mode-desc">점점 빨라지는 속도<br>최대한 멀리 가기!</div>
      </div>
      <div class="racing-mode-card" onclick="selectRacingMode('race')">
        <div class="racing-mode-icon">🏁</div>
        <div class="racing-mode-name">레이스</div>
        <div class="racing-mode-desc">목표 지점까지<br>1000m 완주하기!</div>
      </div>
    </div>

    <div class="racing-gyro-permission" id="racingGyroPermission" style="display:none;">
      <div class="racing-info-box">
        <div class="racing-info-icon">📱</div>
        <div class="racing-info-text">
          이 게임은 휴대폰 기울기를 사용합니다<br>
          <small style="color:var(--text-dim);">좌우로 기울여서 조종하세요</small>
        </div>
      </div>
      <button class="btn btn-primary" onclick="requestGyroPermission()">
        🎮 기울기 권한 요청
      </button>
    </div>
  </div>

  <!-- 게임 화면 -->
  <div class="racing-game-area" id="racingGameArea" style="display:none;">
    <!-- HUD 오버레이 -->
    <div class="racing-hud">
      <div class="racing-hud-left">
        <div class="racing-speed">
          <div class="racing-speed-label">SPEED</div>
          <div class="racing-speed-value" id="racingSpeed">0</div>
          <div class="racing-speed-unit">km/h</div>
        </div>
      </div>
      <div class="racing-hud-center">
        <div class="racing-distance">
          <div class="racing-distance-label">DISTANCE</div>
          <div class="racing-distance-value" id="racingDistance">0</div>
          <div class="racing-distance-unit">m</div>
        </div>
      </div>
      <div class="racing-hud-right">
        <div class="racing-rank" id="racingRank" style="display:none;">
          <div class="racing-rank-label">RANK</div>
          <div class="racing-rank-value" id="racingRankValue">1위/4명</div>
        </div>
      </div>
    </div>

    <!-- 배경 건물 -->
    <div class="racing-bg-buildings" id="racingBuildings">
      <!-- 동적 생성 -->
    </div>

    <!-- 도로 -->
    <div class="racing-road">
      <!-- 차선 라인 -->
      <div class="racing-lane-line" style="left:33.33%;"></div>
      <div class="racing-lane-line" style="left:66.66%;"></div>

      <!-- 차선 점선 애니메이션 -->
      <div class="racing-lane-dashes" id="racingDashes">
        <!-- 동적 생성 -->
      </div>

      <!-- 장애물 컨테이너 -->
      <div class="racing-obstacles" id="racingObstacles">
        <!-- 동적 생성 -->
      </div>

      <!-- 오토바이 (하단 고정) -->
      <div class="racing-bike" id="racingBike">
        <div class="racing-bike-body">🏍️</div>
      </div>
    </div>

    <!-- 핸들바 UI -->
    <div class="racing-handlebar">
      <div class="racing-handlebar-left"></div>
      <div class="racing-handlebar-center"></div>
      <div class="racing-handlebar-right"></div>
    </div>

    <!-- 터치 컨트롤 폴백 -->
    <div class="racing-touch-controls" id="racingTouchControls" style="display:none;">
      <button class="racing-touch-btn racing-touch-left" ontouchstart="racingMoveLane(0)" ontouchend="racingStopMove()">←</button>
      <button class="racing-touch-btn racing-touch-center" ontouchstart="racingMoveLane(1)" ontouchend="racingStopMove()">↑</button>
      <button class="racing-touch-btn racing-touch-right" ontouchstart="racingMoveLane(2)" ontouchend="racingStopMove()">→</button>
    </div>

    <!-- 충돌 효과 오버레이 -->
    <div class="racing-crash-overlay" id="racingCrashOverlay"></div>
  </div>

  <!-- 결과 화면 -->
  <div class="racing-result-screen" id="racingResultScreen" style="display:none;">
    <div class="racing-result-header">
      <div class="racing-result-title" id="racingResultTitle">완주!</div>
      <div class="racing-result-subtitle" id="racingResultSubtitle"></div>
    </div>

    <div class="racing-result-stats">
      <div class="racing-result-stat">
        <div class="racing-result-stat-label">최종 거리</div>
        <div class="racing-result-stat-value" id="racingResultDistance">0m</div>
      </div>
      <div class="racing-result-stat">
        <div class="racing-result-stat-label">최고 속도</div>
        <div class="racing-result-stat-value" id="racingResultMaxSpeed">0 km/h</div>
      </div>
      <div class="racing-result-stat">
        <div class="racing-result-stat-label">플레이 시간</div>
        <div class="racing-result-stat-value" id="racingResultTime">0초</div>
      </div>
    </div>

    <div class="racing-result-rankings" id="racingResultRankings">
      <div class="racing-result-rankings-title">순위</div>
      <div class="racing-result-rankings-list" id="racingResultRankingsList"></div>
    </div>

    <button class="btn btn-primary" onclick="restartRacing()">🔁 다시 하기</button>
    <button class="btn btn-secondary" onclick="leaveGame()" style="margin-top:12px;">← 로비로</button>
  </div>
</div>

<!-- RESULT -->
<div class="result-overlay" id="resultOverlay">
  <div class="result-title" id="resultTitle">🏆 승리!</div>
  <div class="winner-info">
    <div id="winnerName" style="font-size:20px;font-weight:900;"></div>
    <div class="result-cards" id="resultCards"></div>
    <div class="result-hand" id="resultHand"></div>
    <div class="result-pot" id="resultPot"></div>
  </div>
  <button class="btn btn-primary" onclick="closeResult()" style="max-width:280px;">다음 라운드</button>
</div>

<!-- QR Code library -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="js/core.js"></script>
<script src="js/games.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="js/yahtzee-three.js"></script>
</body>
</html>
